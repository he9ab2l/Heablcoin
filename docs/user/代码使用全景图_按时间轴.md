# Heablcoin 代码使用全景图

让新成员/操作者按"时间轴"快速定位该用哪些脚本、输入输出什么数据、以及数据如何流转。

---

## 第一部分：项目环境与技术栈

### 项目依赖环境

#### Python 版本要求
- ✅ 推荐：Python `3.10+`（本仓库在本地已以 Python `3.13` 跑通 `tests/run_tests.py all`）
- ⚠️ 说明：未做依赖版本锁定；如遇依赖不兼容，建议固定到一套可复现的 `requirements.txt` 版本集合。

#### 操作系统支持
| 操作系统 | 支持 | 说明 |
| --- | --- | --- |
| Windows 10/11 | ✅ | 本地开发/调试 |
| Linux（Ubuntu 24.04 LTS） | ✅ | 云端部署（ECS） |
| macOS | ✅ | 理论可用（未在本仓库记录里做系统级验证） |

#### 核心依赖库列表（分类展示）

| 分类 | 依赖 | 是否必需 | 用途 |
| --- | --- | --- | --- |
| 🧠 MCP 框架 | `mcp`（含 `fastmcp`） | 必需 | MCP Server、工具注册与 JSON-RPC 通信 |
| 🏦 交易所 | `ccxt` | 必需 | Binance 等交易所行情/下单统一接口 |
| 📊 数据处理 | `pandas`, `numpy` | 必需 | 技术指标、统计、报告生成 |
| ⚙️ 配置管理 | `python-dotenv` | 必需 | 加载 `.env` |
| 🧾 文档/渲染 | `markdown` | 必需 | 报告渲染（Markdown） |
| 🌐 HTTP | `aiohttp` | 可选 | 更好的异步网络能力（可按需启用） |
| 📮 通知 | `python-telegram-bot` | 可选 | Telegram 通知（未安装时会友好报错） |
| 🧰 云端队列 | `redis` | 可选 | 云端任务队列/结果回写（未安装时会友好报错） |
| 🌍 Cloud Worker | `requests` | 可选 | 云端 pipeline worker 的搜索/通知调用（仅启用该 worker 才需要） |

---

### 🔧 技术栈与核心库

#### 1) 🧠 MCP / FastMCP
- 版本要求：未锁定（以 pip 安装为准）
- 用途说明：将交易/研究/风控/学习/报告等能力以 MCP Tools 形式暴露给 Claude Desktop / Windsurf / Codex CLI
- 核心组件：
  - `Heablcoin.py`：稳定入口包装器
  - `src/core/server.py`：FastMCP Server 与统一工具注册
  - `src/core/mcp_safety.py`：工具调用隔离（异常保护 + stdout 防污染 + 审计/备份）
- 关键应用场景：自然语言驱动分析、自动化下单、报告生成与推送、云端任务发布

#### 2) 🏦 CCXT
- 版本要求：未锁定
- 用途说明：统一交易所 API（行情、K 线、账户、下单）
- 核心组件：
  - `src/core/exchange.py`：交易所连接池
  - `src/utils/exchange_adapter.py`：统一接口封装与便捷方法
- 关键应用场景：`get_market_analysis*`、`place_order`、`get_account_summary` 等工具链路

#### 3) 📊 Pandas / NumPy
- 版本要求：未锁定
- 用途说明：技术指标/统计分析/指标管线
- 核心组件：
  - `src/skills/market_analysis/indicators/*`
  - `src/skills/personal_analytics/modules/*`
- 关键应用场景：多模块市场分析、个人绩效归因、报告生成

#### 4) ☁️ Redis（可选）
- 版本要求：未锁定
- 用途说明：用于“本地 ↔ 云端”任务队列通信（list）与结果回写（hash）
- 核心组件：
  - `src/storage/redis_adapter.py`：Redis 读写与队列封装（可选依赖）
  - `src/tools/cloud_tools.py`：发布/查询任务（含 pipeline queue）
  - `src/core/cloud/pipeline_worker.py`：云端 worker（消费队列、写回结果、推送通知）
- 关键应用场景：把研究/总结/消息推送放到云端跑（ECS Docker + Redis + 青龙 worker）

---

### 🚀 环境安装指南

#### 快速安装（本地）

```bash
git clone <your_repo_url>
cd MCP

python -m venv .venv
# Windows
.venv\\Scripts\\activate
# Linux/macOS
source .venv/bin/activate

pip install -r requirements.txt

# 可选能力按需安装（不装不影响核心 MCP server 启动）
pip install redis requests python-telegram-bot
```

#### 配置文件示例（`.env`）

```ini
# === 必需：MCP/编码（Windows 强烈建议） ===
PYTHONIOENCODING=utf-8
PYTHONUTF8=1

# === 交易所（可选：不下单可不配，但行情分析通常需要） ===
BINANCE_API_KEY=
BINANCE_SECRET_KEY=
EXCHANGE=binance
NETWORK=testnet

# === LLM（可选：仅在调用 AI 编排/研究工具时需要） ===
HEABL_LLM_DEFAULT=deepseek
HEABL_DEEPSEEK_KEY=
HEABL_DEEPSEEK_MODEL=deepseek-chat

# === 邮件（可选：仅在启用邮件推送时需要） ===
EMAIL_NOTIFICATIONS_ENABLED=False
SENDER_EMAIL=
SENDER_PASSWORD=
RECIPIENT_EMAIL=
SMTP_SERVER=
SMTP_PORT=587

# === Redis（可选：仅在启用云端任务/worker 时需要） ===
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=
TASK_QUEUE_KEY=mcp:tasks
RESULT_HASH_KEY=mcp:results
```

#### 验证安装

```bash
# 最小自检
python tests/run_tests.py unit

# 全链路（含 integration）
python tests/run_tests.py all

# 启动 MCP server（stdio 模式）
python Heablcoin.py
```

---

### 💻 系统要求

#### 硬件要求（参考）
| 项目 | 最低 | 推荐 |
| --- | --- | --- |
| CPU | 2 核 | 4 核+ |
| 内存 | 4GB | 8GB+ |
| 磁盘 | 1GB | 10GB+ |

#### 网络要求
| 用途 | 是否需要联网 | 说明 |
| --- | --- | --- |
| MCP client ↔ server（本地） | ❌ | stdio 通信 |
| 交易所行情/下单 | ✅ | 访问 Binance/交易所 API |
| AI 编排/研究 | ✅ | 访问 OpenAI/DeepSeek/Claude 等 |
| 云端任务（Redis） | ✅ | 本地可通过 SSH 隧道访问云端 Redis |

#### 本地 ↔ 云端 Redis 通信（示例）

```bash
ssh -N -L 6379:127.0.0.1:26739 root@<ECS_IP>
```

---

## 第二部分：代码使用全景图

### 1) ⚡ 极简版总览（完整流程）

```text
┌──────────────────────┐      stdio JSON-RPC       ┌──────────────────────────┐
│  Claude / Windsurf    │  ───────────────────────▶ │  Heablcoin.py             │
│  Codex CLI (MCP)      │  ◀─────────────────────── │  src/core/server.py        │
└──────────────────────┘                            └───────────┬──────────────┘
                                                                │ 注册工具（tools/skills）
                                                                ▼
                                                     ┌──────────────────────────┐
                                                     │  src/tools/* (MCP Tools) │
                                                     │  src/skills/* (业务能力) │
                                                     └───────────┬──────────────┘
                                                                 │
                 ┌───────────────────────────────┬───────────────┴───────────────────────────────┐
                 ▼                               ▼                                               ▼
        ┌──────────────────┐            ┌──────────────────┐                            ┌──────────────────┐
        │  交易所 API       │            │  LLM Providers   │                            │  Storage / Logs  │
        │  (CCXT)           │            │  (OpenAI/DeepSeek)│                            │  sqlite/redis/log │
        └──────────────────┘            └──────────────────┘                            └──────────────────┘
```

---

### 2) 🕘 按时间轴展开详细流程（可直接照着跑）

#### ⏱️ 时间轴 0：环境准备（T-5min）

```text
┌──────────┐       ┌──────────────┐       ┌──────────┐
│ .env.example │ ─▶ │   .env 配置    │ ─▶ │  环境可运行 │
└──────────┘       └──────────────┘       └──────────┘
```

- 📂 核心脚本列表：`requirements.txt`、`.env.example`、`docs/user/配置指南.md`
- ⏱️ 预估耗时：2–10 分钟（首次装依赖取决于网络）
- 🎯 功能说明：准备运行环境与可选依赖；保证 UTF-8 与密钥不入库
- 📥 输入数据：`.env.example`（INI 格式模板）
- 📤 输出数据：`.env`（INI 格式，自填密钥）
- ⚠️ 重要提醒：
  - 提交前运行：`python scripts/scan_secrets.py --staged`
  - Windows 建议设置：`PYTHONIOENCODING=utf-8`、`PYTHONUTF8=1`

#### ⏱️ 时间轴 1：启动 MCP Server（T+0）

```text
┌──────────────┐      ┌──────────────────────┐      ┌──────────────────┐
│ Heablcoin.py  │ ───▶ │ src/core/server.py   │ ───▶ │ MCP Tools 可调用  │
└──────────────┘      └──────────────────────┘      └──────────────────┘
```

- 📂 核心脚本列表：`Heablcoin.py`、`src/core/server.py`、`src/core/mcp_safety.py`、`src/tools/*`
- ⏱️ 预估耗时：10–30 秒
- 🎯 功能说明：加载 `.env`、初始化日志/缓存/交易所连接池、注册 MCP tools 并启动 stdio 服务
- 📥 输入数据：
  - `.env`（INI）
  - MCP 客户端配置（Claude Desktop / Windsurf / Codex CLI）
- 📤 输出数据：
  - MCP stdio 服务（JSON-RPC）
  - 日志：`logs/*.log`、`logs/*.jsonl`（启用 SmartLogger 时）
  - 审计备份（可选）：`data/mcp_call_backups/YYYYMMDD/*.json`
- ⚠️ 重要提醒：
  - MCP 协议通道使用 stdout，禁止污染；相关开关见：`MCP_FORCE_PRINT_TO_STDERR`、`MCP_REDIRECT_STDOUT`

#### ⏱️ 时间轴 2：市场分析/研究（T+1~3min）

```text
┌──────────┐      ┌────────────────────────┐      ┌──────────────────┐
│ symbol/tf │ ───▶ │ market_analysis_tools   │ ───▶ │ Markdown/JSON 输出 │
└──────────┘      └────────────────────────┘      └──────────────────┘
```

- 📂 核心脚本列表：
  - `src/tools/market_analysis_tools.py`
  - `src/skills/market_analysis/*`
  - `src/core/exchange.py`（行情来源）
- ⏱️ 预估耗时：5–60 秒（取决于网络与数据量）
- 🎯 功能说明：拉取行情/K线 → 指标管线计算 → 模块化分析 → 汇总输出
- 📥 输入数据：
  - symbol：例如 `BTC/USDT`
  - timeframe：例如 `1h`
- 📤 输出数据：
  - MCP 返回：Markdown/JSON（按工具参数）
  - 可选缓存：SmartCache（内存/本地 TTL）
- ⚠️ 重要提醒：
  - 若交易所/网络不可用，分析会降级或报错；建议先用 `get_system_status()` 检查

#### ⏱️ 时间轴 3：风控 & 策略治理（T+1~2min）

```text
┌──────────┐      ┌──────────────────┐      ┌──────────────────┐
│ 风控输入  │ ───▶ │ risk/strategy     │ ───▶ │ 允许/拦截/建议输出 │
└──────────┘      └──────────────────┘      └──────────────────┘
```

- 📂 核心脚本列表：
  - `src/tools/risk_tools.py`、`src/skills/risk/*`
  - `src/tools/strategy_tools.py`、`src/skills/strategy/*`
  - `src/tools/governance_tools.py`、`src/skills/governance/*`
- ⏱️ 预估耗时：1–10 秒
- 🎯 功能说明：风险预算/资金池/熔断器/策略注册与绩效跟踪/AI 决策评分与审计
- 📥 输入数据：预算/亏损记录/策略 name/tags、市场波动与流动性参数等
- 📤 输出数据：风险状态、仓位建议、审计事件记录（可选写入存储）
- ⚠️ 重要提醒：
  - 可通过工具开关做“软禁用”，避免误操作：`TOOLS_DISABLED` / `TOOLS_ENABLED_ONLY`

#### ⏱️ 时间轴 4：交易执行 & 交易记录（T+秒级）

```text
┌──────────┐      ┌──────────────────┐      ┌────────────────────┐
│ 下单参数  │ ───▶ │ place_order/...   │ ───▶ │ trades.db / CSV 记录 │
└──────────┘      └──────────────────┘      └────────────────────┘
```

- 📂 核心脚本列表：`src/core/server.py`、`src/core/exchange.py`、`src/utils/trade_storage.py`
- ⏱️ 预估耗时：0.5–5 秒（取决于交易所响应）
- 🎯 功能说明：执行下单/撤单/查询；落盘交易流水供绩效分析与学习模块复用
- 📥 输入数据：symbol/side/amount/price 等（工具参数）
- 📤 输出数据：
  - 交易所返回：order_id/status
  - 本地存储（默认）：`data/` 下的 sqlite 数据库（见 `src/utils/trade_storage.py` 里的默认路径）
- ⚠️ 重要提醒：
  - 强烈建议先用测试网（`NETWORK=testnet`），并限制 `ALLOWED_SYMBOLS`、`MAX_TRADE_AMOUNT`

#### ⏱️ 时间轴 5：报告生成与通知推送（T+秒级~分钟）

```text
┌──────────┐      ┌──────────────────────────┐      ┌──────────────────┐
│ 报告参数  │ ───▶ │ flexible_report/service   │ ───▶ │ Email/Server酱/飞书 │
└──────────┘      └──────────────────────────┘      └──────────────────┘
```

- 📂 核心脚本列表：
  - `src/skills/report/flexible_report/*`
  - `src/storage/email_adapter.py`
  - `src/utils/notifier.py`
- ⏱️ 预估耗时：1–30 秒
- 🎯 功能说明：聚合市场/绩效/学习输出 → 渲染报告 → 多通道推送（可选）
- 📥 输入数据：报告标题、要发送的模块开关（A/B/C...）、SMTP/通知配置（环境变量）
- 📤 输出数据：邮件/通知消息；可选落盘备份（取决于模块配置）
- ⚠️ 重要提醒：
  - 外部通道（SMTP/Server酱/飞书）均为可选，不配置不影响主流程

#### ⏱️ 时间轴 6：云端 Pipeline 任务（可选，T+持续）

```text
┌────────────────────┐      ┌────────────────────────────┐      ┌──────────────────┐
│ MCP publish_* tool   │ ───▶ │ Redis list: TASK_QUEUE_KEY │ ───▶ │ pipeline_worker   │
└────────────────────┘      └────────────────────────────┘      └─────────┬────────┘
                                                                          │ 写回
                                                                          ▼
                                                             ┌──────────────────────────┐
                                                             │ Redis hash: RESULT_HASH_KEY│
                                                             └──────────────────────────┘
```

- 📂 核心脚本列表：
  - `src/tools/cloud_tools.py`（发布/查询任务；含 `publish_pipeline_task/get_pipeline_result`）
  - `src/core/cloud/pipeline_worker.py`（云端 worker：搜索/总结/推送/写回）
  - `qinglong_worker.py`（青龙 worker，可按需对接）
- ⏱️ 预估耗时：
  - 发布任务：< 1 秒
  - worker 执行：20 秒 – 5 分钟（取决于搜索/LLM/通知）
- 🎯 功能说明：把耗时/需要联网的研究任务交给云端执行，并将结果回写到 Redis 供 MCP 查询
- 📥 输入数据：
  - Redis 连接：`REDIS_URL` 或 `REDIS_HOST/REDIS_PORT/REDIS_PASSWORD`
  - worker API：`HEABL_TAVILY_KEY`、`HEABL_DEEPSEEK_KEY`（仅 worker 用）
- 📤 输出数据：Redis hash 中的结果对象；可选通知推送（Server酱/飞书）
- ⚠️ 重要提醒：
  - Redis 默认键：`TASK_QUEUE_KEY=mcp:tasks`、`RESULT_HASH_KEY=mcp:results`
  - 未配置 Redis/LLM/通知时不影响本地 MCP 主链路（仅云端 pipeline 不可用）

#### ⏱️ 时间轴 7：学习/复盘闭环（T+事后）

```text
┌──────────┐      ┌──────────────────┐      ┌──────────────────┐
│ 交易记录  │ ───▶ │ learning_tools    │ ───▶ │ 行为提醒/训练建议 │
└──────────┘      └──────────────────┘      └──────────────────┘
```

- 📂 核心脚本列表：`src/tools/learning_tools.py`、`src/skills/learning/*`、`src/tools/personal_analytics_tools.py`
- ⏱️ 预估耗时：5–60 秒
- 🎯 功能说明：将交易记录/市场状态与学习模块联动，输出训练建议、执行守护与复盘提示
- 📥 输入数据：交易流水（sqlite/CSV）、用户回答、会话参数
- 📤 输出数据：学习会话记录、复盘输出（可选同步 Notion）
- ⚠️ 重要提醒：
  - “学习/训练”与“绩效分析”共用同一交易流水与报告输出，建议先保证交易记录写入正常

---

### 3) 📁 核心文件清单（按功能分类）

| 分类 | 关键文件 | 作用 |
| --- | --- | --- |
| 入口 | `Heablcoin.py` | MCP Server 稳定入口 |
| 核心 | `src/core/server.py` | FastMCP 服务端、工具注册、主链路 |
| 安全 | `src/core/mcp_safety.py` | 工具调用隔离、审计日志与备份、stdout 保护 |
| 工具 | `src/tools/*` | 面向 MCP 暴露的工具层（market/risk/learning/cloud/...） |
| 技能 | `src/skills/*` | 业务能力实现层（分析/学习/风控/报告/...） |
| 编排 | `src/core/orchestration/*` | 多模型路由与 AI 角色/任务编排 |
| 存储 | `src/storage/*` | email/notion/redis/file 适配 |
| 通用 | `src/utils/*` | 日志、缓存、风控、校验、交易落盘等 |
| 云端 | `src/core/cloud/pipeline_worker.py` | 云端研究任务 worker（可选） |
| 测试 | `tests/run_tests.py` | 单测/集成测试统一入口 |
| 架构 | `可视化系统架构.mmd` | Mermaid 架构图（分层 + 数据流） |

---

### 4) 🎯 关键数据文件流转图

```text
┌──────────────┐
│   .env/.env.example  │
└──────┬───────┘
       ▼
┌──────────────────────┐            ┌──────────────────────┐
│  MCP Server (stdio)   │──────────▶ │ logs/* (审计/运行日志) │
│  Heablcoin.py/server  │            └──────────────────────┘
└──────┬───────────────┘
       │
       ├──────────────▶ data/mcp_call_backups/YYYYMMDD/*.json   (可选：每次工具调用备份)
       │
       ├──────────────▶ data/* (sqlite/CSV 等交易记录与分析缓存)
       │
       └──────────────▶ Redis (可选：TASK_QUEUE_KEY / RESULT_HASH_KEY)
                           │
                           ▼
                    pipeline_worker.py（云端消费/写回/通知）
```

---

### 5) 📌 使用说明（如何快速定位你要改/要用的代码）

- 🔍 查“某个工具”在哪里实现：优先看 `docs/developer/API参考.md`，再到 `src/tools/*` 搜索对应函数名。
- 🧭 查“某段流程”涉及哪些文件：按本文件的“时间轴 1~7”定位，然后打开对应 `src/*` 文件。
- 🧪 想先验证不依赖 MCP 客户端：运行 `python Heablcoin-test.py` 或 `python tests/run_tests.py all`。
- 🧩 想理解整体分层：打开 `可视化系统架构.mmd`（Mermaid `graph TB`）。

---

## 参考资料
- （未提供）如有“操作手册 PDF/流程图”，可在此追加路径并补全时间轴颗粒度。

