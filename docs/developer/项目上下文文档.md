# Project Context Document（项目上下文文档）

## 2.1 项目概要（Project Overview）

```yaml
项目概要:
  项目名称: "Heablcoin"
  项目背景: "基于 MCP（Model Context Protocol）与 LLM 的智能加密货币交易分析与执行系统，支持市场分析、交易执行、绩效分析、云端任务与通知等能力"
  目标与目的: "通过 MCP 工具化接口，将行情分析、交易执行、风控、回测、通知与云端任务编排整合为可被 Claude Desktop / Windsurf 等客户端调用的服务"
  要解决的问题: "在本地与云端场景下，为加密货币交易提供可复用的分析、执行、风控与通知能力，并提供工程化可维护的文档与可视化体系"
  整体愿景: "构建一个可扩展的‘本地 MCP + 云端任务 + 多 AI + 多通道推送’交易智能系统，保证安全默认、可追踪、可扩展"
```

---

## 2.2 范围定义（Scope Definition）

```yaml
范围定义:
  当前范围: "对 Heablcoin 仓库进行工程化增强与文档体系建设，包括：Python 文件头注释标准化、代码使用全景图文档、工程化记忆与任务追踪文件、系统架构 Mermaid 可视化、日志系统结构化可定位增强"
  非本次范围: "暂无信息"
  约束条件:
    - "扫描与批量修改仅针对 .py 文件头部注释，禁止修改业务逻辑代码"
    - "必须排除虚拟环境与构建目录（如 .venv、venv、site-packages、__pycache__ 等）"
    - "MCP Server 进程中禁止向 stdout 打印污染协议输出"
    - "日志与报错必须可精确定位（北京时间、模块、函数、文件路径、行号、错误码、上下文）"
```

---

## 2.3 关键实体与关系（Key Entities & Relationships）

```yaml
实体信息:
  核心实体:
    - "MCP Server（Heablcoin.py）"
    - "MCP 客户端（Claude Desktop / Windsurf IDE）"
    - "市场分析模块（market_analysis/）"
    - "个人绩效模块（personal_analytics/）"
    - "云端任务模块（cloud/）"
    - "AI 编排模块（orchestration/）"
    - "工具与基础设施（utils/）"
    - "存储适配层（storage/）"
    - "测试体系（tests/、Heablcoin-test.py）"
    - "交易所适配与交易所 API（ccxt + Binance/OKX/Bybit）"
    - "通知系统（utils/notifier.py + 邮件/Telegram 等）"
    - "Redis（云端队列，可选）"
  实体职责:
    "MCP Server（Heablcoin.py）": "作为服务入口，注册 MCP 工具并处理来自 MCP 客户端的请求，协调分析、交易、云端任务、通知等能力"
    "MCP 客户端（Claude Desktop / Windsurf IDE）": "作为用户交互端，通过 MCP 调用工具并接收结果"
    "市场分析模块（market_analysis/）": "获取行情与K线数据，计算技术指标，产出分析摘要、信号与结构化结果"
    "个人绩效模块（personal_analytics/）": "聚合交易记录与账户信息，计算绩效、风险、归因与行为分析报告"
    "云端任务模块（cloud/）": "将部分任务发布到队列并在 Worker 中执行，支持调度、发布、执行、API 管理等能力"
    "AI 编排模块（orchestration/）": "对 AI 相关任务进行路由、角色定义与任务编排，支持多提供商与多角色"
    "工具与基础设施（utils/）": "提供通用能力，如日志、缓存、性能监控、风控、回测、通知、交易所适配"
    "存储适配层（storage/）": "提供文件/Redis/Email/Notion 等存储与输出通道适配"
    "测试体系（tests/、Heablcoin-test.py）": "提供快速自检与集成测试，验证工具模块、日志缓存、异常处理等核心链路"
    "交易所适配与交易所 API（ccxt + Binance/OKX/Bybit）": "统一交易所访问接口，支撑行情获取与交易执行扩展"
    "通知系统（utils/notifier.py + 邮件/Telegram 等）": "将关键事件与报告推送到不同渠道，支持可插拔通道"
    "Redis（云端队列，可选）": "作为云端任务队列与状态协作组件"
  实体关系描述: "MCP 客户端通过 MCP 协议调用 Heablcoin.py 注册的工具，工具内部调用 market_analysis/personal_analytics/orchestration/cloud/utils/storage 等模块；云端任务通过 Redis 队列在 qinglong_worker.py / cloud 执行器中消费并回传结果；通知由 notifier 与 storage 适配器对外发送；全链路日志由 utils/smart_logger.py 统一记录并支持错误码追踪"
```

---

## 2.4 功能模块拆解（Functional Decomposition）

```yaml
功能模块:
  模块列表:
    - "系统入口与 MCP 服务"
    - "市场分析"
    - "交易执行与风控"
    - "个人绩效分析"
    - "云端任务与调度"
    - "AI 编排"
    - "通知与输出"
    - "存储与集成"
    - "工程化文档与可视化"
    - "测试与自检"
  模块详情:
    系统入口与 MCP 服务:
      输入: "来自 MCP 客户端的工具调用请求、.env 配置"
      输出: "工具调用结果（JSON/Markdown/文本）、日志文件"
      核心逻辑: "初始化环境与依赖，注册工具，处理请求并分发到各功能模块"
    市场分析:
      输入: "交易对、时间周期、历史K线/行情数据、可选外部信息源"
      输出: "技术指标结果、趋势/情绪/结构分析、交易信号、分析报告"
      核心逻辑: "通过数据提供器获取 OHLCV，计算指标，组合分析模块生成结构化结论"
    交易执行与风控:
      输入: "下单参数、账户状态、白名单与风险参数"
      输出: "下单结果、风控校验结果、交易记录、通知推送"
      核心逻辑: "执行风控检查，计算仓位与止损/追踪止损，调用交易所适配器提交订单并落库/通知"
    个人绩效分析:
      输入: "交易历史、账户余额、订单与持仓记录、本地交易记录"
      输出: "绩效统计、风险指标、归因与行为分析报告"
      核心逻辑: "聚合数据源，计算收益、胜率、回撤等指标，产出结构化报告"
    云端任务与调度:
      输入: "发布的任务描述、任务优先级、依赖关系、Redis 队列"
      输出: "任务执行结果、状态更新、通知"
      核心逻辑: "任务发布与调度，Worker 消费队列并执行任务，回填结果"
    AI 编排:
      输入: "任务类型、上下文、可用 AI 提供商配置"
      输出: "模型生成内容、路由决策、失败回退结果"
      核心逻辑: "根据任务复杂度与成本策略进行路由，支持多角色提示词与多提供商切换"
    通知与输出:
      输入: "交易事件、预警事件、报告内容、错误事件"
      输出: "邮件/Telegram 等外部消息、日志记录"
      核心逻辑: "通过 Notifier 聚合多通道发送，支持可插拔 Channel"
    存储与集成:
      输入: "结构化数据、报告、任务结果"
      输出: "文件/Redis/Notion/Email 等落地结果"
      核心逻辑: "以适配器模式封装不同存储与集成目标"
    工程化文档与可视化:
      输入: "项目代码结构与依赖信息、需求规范"
      输出: "代码头注释、代码使用全景图文档、系统架构 Mermaid 图、历史记录与任务进度文件"
      核心逻辑: "批处理脚本自动添加头注释，生成全景图文档与架构图，维护工程化追踪文件"
    测试与自检:
      输入: "本地环境、核心模块导入、日志/缓存/异常处理链路"
      输出: "测试报告与结果码"
      核心逻辑: "快速集成测试与终端自检，确保基础链路可用"
  典型用户场景: "用户在 Claude Desktop/Windsurf 中发起‘分析 BTC 走势’或‘执行交易/查询绩效/发布云端任务’等指令，由 MCP 工具串联行情获取、分析、可选 AI 编排、执行与通知，最终返回结构化结果"
```

---

## 2.5 技术方向与关键决策（Technical Direction & Decisions）

```yaml
技术方向:
  客户端: "Claude Desktop / Windsurf IDE（通过 MCP 接入）"
  服务端: "Python MCP Server（Heablcoin.py）"
  模型或算法层: "LLM + 规则/指标计算（技术指标、信号生成、风险管理），多 AI 提供商方向已规划"
  数据流与架构: "本地 MCP 请求 -> 模块处理（分析/交易/绩效/编排）-> 可选云端队列 -> 输出/通知；工具层提供日志、缓存、风控、回测等支撑"
  已做技术决策:
    - "新增 utils/exchange_adapter.py：统一交易所适配接口，提供 Binance 实现与 OKX/Bybit 桩代码"
    - "新增 utils/backtesting.py：提供基础回测能力 run_backtest"
    - "新增 utils/notifier.py：提供可插拔通知框架，支持 Console 与 Telegram"
    - "新增 utils/risk_management.py：提供仓位计算与追踪止损"
    - "更新 utils/__init__.py：导出新增工具模块"
    - "更新 README.md 与 README.zh-CN.md：补充新特性与可选依赖"
    - "创建 dev/add_headers.py：批量为 Python 文件添加标准化头注释"
    - "生成 docs/user/代码使用全景图_按时间轴.md：代码使用全景图文档"
    - "创建 可视化系统架构.mmd：Mermaid 分层架构图与数据流图"
    - "创建 历史记录.json 与 任务进度.json：结构化变更追踪与任务追踪"
    - "强化 utils/smart_logger.py：结构化 JSON 日志输出、北京时间、错误码生成、上下文错误记录、标准异常类"
  可替代方案:
    - "使用成熟量化交易框架替代自研框架（Freqtrade、Jesse）"
    - "使用其他通知聚合服务或告警平台替代自研通知（暂无信息）"
    - "使用其他任务队列替代 Redis（暂无信息）"
```

---

## 2.6 交互、风格与输出约定（Interaction & Style Conventions）

```yaml
交互约定:
  AI 输出风格: "结构清晰、层级明确、工程化表达"
  表达规范: "统一使用 Markdown；必要时使用伪代码或列表"
  格式要求: "严谨、有序、模块化、可迁移"
  用户特殊偏好:
    - "中文输出"
    - "要求流程标准化文档时，必须按指定固定结构与格式输出"
    - "要求工程化追踪：历史记录.json 追加写入，不覆盖"
    - "要求架构可视化：可视化系统架构.mmd 与工程结构保持同步"
    - "要求任务追踪：任务进度.json 维护 Project/Task 两级结构"
    - "要求日志与报错必须可精确定位，禁止模糊提示"
```

---

## 2.7 当前进展总结（Current Status）

```yaml
进展总结:
  已确认事实:
    - "项目根目录为 d:\\MCP"
    - "Python 版本要求为 3.8+"
    - "requirements.txt 核心依赖包含 mcp、ccxt、pandas、numpy、python-dotenv、markdown，可选 aiohttp"
    - "已完成为 112 个 Python 文件批量添加标准化头注释（保留 shebang 与 encoding，且不改业务逻辑）"
    - "已生成代码使用全景图文档 docs/user/代码使用全景图_按时间轴.md"
    - "已新增 utils 模块：exchange_adapter、backtesting、notifier、risk_management 并更新导出"
    - "已创建工程化文件：历史记录.json、任务进度.json、可视化系统架构.mmd"
    - "已强化 smart_logger 为结构化可定位日志并通过 quick tests 验证通过"
    - "已生成多端连接集成的流程标准化文档 docs/developer/runbooks/多端连接集成流程标准化.md"
    - "快速集成测试 python tests/run_tests.py --quick 结果为通过"
  未解决问题:
    - "多 AI 提供商与多通道推送的具体代码落地实现细节与配置参数仍需根据实际需求进一步确定"
    - "云端服务器部署方式（VPS/Docker/青龙面板）在实际环境中的最终选择暂无信息"
    - "通知渠道范围（Discord/企业微信/钉钉等）是否纳入本仓库正式实现暂无信息"
```

---

## 2.8 后续计划与风险（Next Steps & Risks）

```yaml
后续计划:
  待讨论主题:
    - "多 AI：具体支持哪些提供商、路由策略、成本控制与失败回退策略"
    - "云端任务：队列与执行器的部署标准、可观测性与重试策略"
    - "多通道推送：需要正式支持的渠道列表与统一消息模板"
    - "安全：API Key 管理、敏感信息脱敏、审计与权限控制"
  潜在风险与不确定性:
    - "MCP stdout 污染导致协议异常的风险"
    - "交易执行与风控策略不完善导致资金风险"
    - "外部 API（交易所/模型/通知）限流、封禁与网络不稳定"
    - "云端队列与 Worker 的可用性与一致性问题"
  推荐的后续初始化 Prompt: "请以 Heablcoin 项目为上下文，基于现有模块（MCP 本地、cloud、orchestration、notifier、storage、utils），优先实现多 AI 路由与多通道通知的最小可用闭环，并确保日志具备北京时间、错误码、文件路径、行号与上下文，所有变更同步更新历史记录.json、任务进度.json 与 可视化系统架构.mmd"
```
