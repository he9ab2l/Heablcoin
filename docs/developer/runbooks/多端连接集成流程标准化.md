# Heablcoin 多端连接集成流程标准化文档

## 1 目的

1. 实现 MCP 本地服务与云端服务器的双向通信
2. 集成多个 AI 提供商（OpenAI、DeepSeek、Anthropic、本地模型）实现智能路由和故障转移
3. 建立多通道信息推送体系（邮件、Telegram、Discord、企业微信、钉钉）
4. 构建完整的本地-云端-AI-通知四层联动架构

## 2 适用范围

1. Heablcoin MCP Server 本地部署环境
2. 云端服务器（青龙面板、自建 VPS、Docker 容器）
3. AI 服务调用场景（市场分析、策略建议、报告生成）
4. 实时通知场景（价格预警、交易执行、系统异常）

## 3 注意事项

1. 所有 API 密钥必须存储在 `.env` 文件中，禁止硬编码
2. 云端服务器必须配置 HTTPS 或内网穿透，确保通信安全
3. AI 调用必须设置超时和重试机制，单次请求超时不超过 30 秒
4. 通知推送必须设置频率限制，避免触发平台反垃圾机制
5. Redis 连接必须配置 SSL，生产环境禁止使用无密码连接
6. 所有敏感操作必须记录到 `trading.log`，便于审计追踪
7. 多 AI 调用时优先使用成本较低的模型，仅复杂任务升级到高级模型

## 4 相关模板或工具

1. 环境配置模板：`.env.example`
2. 云端任务管理：`cloud/task_manager.py`
3. AI 编排路由：`orchestration/router.py`
4. API 管理器：`cloud/api_manager.py`
5. 通知工具：`utils/notifier.py`
6. 邮件适配器：`storage/email_adapter.py`
7. Redis 适配器：`storage/redis_adapter.py`
8. 青龙 Worker：`qinglong_worker.py`
9. 任务执行器：`cloud/task_executor.py`

## 5 流程步骤

### 第一阶段：MCP 本地服务配置

1. 打开项目根目录，复制环境配置模板
   ```
   cp .env.example .env
   ```

2. 编辑 `.env` 文件，填写交易所 API 配置
   ```
   BINANCE_API_KEY=你的API密钥
   BINANCE_SECRET=你的API密钥
   USE_TESTNET=true
   ```

3. 安装项目依赖
   ```
   pip install -r requirements.txt
   ```

4. 运行快速自检验证本地环境
   ```
   python tests/run_tests.py unit
   ```

5. 启动 MCP Server 验证服务正常
   ```
   python Heablcoin.py
   ```

6. 在 Claude Desktop 或 Windsurf 中配置 MCP 连接
   - 打开 `claude_desktop_config.json` 或 `mcp_config.json`
   - 添加 heablcoin 服务配置指向 `Heablcoin.py` 绝对路径
   - 重启客户端验证工具列表加载成功

### 第二阶段：云端服务器部署

7. 准备云端服务器环境（VPS/Docker/青龙面板任选其一）
   - VPS：Ubuntu 20.04+ 或 CentOS 7+
   - Docker：准备 `Dockerfile` 或使用官方 Python 镜像
   - 青龙面板：确保已安装 Python 3.10+ 环境

8. 在云端服务器安装 Redis 服务
   ```
   # Ubuntu
   sudo apt update && sudo apt install redis-server
   sudo systemctl enable redis-server
   sudo systemctl start redis-server
   ```

9. 配置 Redis 访问密码和远程连接
   - 编辑 `/etc/redis/redis.conf`
   - 设置 `requirepass 你的Redis密码`
   - 设置 `bind 0.0.0.0` 允许远程连接
   - 重启 Redis 服务

10. 将项目代码同步到云端服务器
    ```
    git clone https://github.com/your/heablcoin.git
    cd heablcoin
    pip install -r requirements.txt
    ```

11. 在云端服务器配置 `.env` 文件
    ```
    REDIS_URL=redis://:你的Redis密码@localhost:6379
    REDIS_SSL=false
    REDIS_MONITOR_QUEUE_KEY=heablcoin:monitor_queue
    ```

12. 启动青龙 Worker 或自定义守护进程
    ```
    # 单次运行模式
    RUN_ONCE=true python qinglong_worker.py
    
    # 持续轮询模式（生产环境）
    RUN_ONCE=false WORKER_INTERVAL=60 python qinglong_worker.py
    ```

13. 验证本地与云端 Redis 通信
    - 本地执行 `publish_cloud_task` MCP 工具发布测试任务
    - 云端 Worker 日志确认收到并处理任务

### 第三阶段：多 AI 提供商集成

14. 在 `.env` 文件中配置多个 AI 提供商密钥
    ```
    # OpenAI
    OPENAI_API_KEY=sk-xxx
    OPENAI_BASE_URL=https://api.openai.com/v1
    OPENAI_MODEL=gpt-4o-mini
    
    # DeepSeek
    DEEPSEEK_API_KEY=sk-xxx
    DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
    DEEPSEEK_MODEL=deepseek-chat
    
    # Anthropic
    ANTHROPIC_API_KEY=sk-ant-xxx
    ANTHROPIC_MODEL=claude-3-haiku-20240307
    
    # 本地模型（Ollama）
    LOCAL_LLM_BASE_URL=http://localhost:11434/v1
    LOCAL_LLM_MODEL=qwen2:7b
    ```

15. 编辑 `cloud/api_manager.py` 添加 AI 端点配置
    - 使用 `ApiManager.add_endpoint()` 方法注册每个提供商
    - 设置优先级：本地模型(1) > DeepSeek(2) > OpenAI(3) > Anthropic(4)
    - 配置每个端点的 `max_requests_per_minute` 速率限制

16. 配置 AI 路由策略
    - 打开 `orchestration/router.py`
    - 设置默认路由规则：简单任务走本地模型，复杂任务走云端 API
    - 配置故障转移：当前端点失败自动切换下一优先级

17. 编辑 `orchestration/ai_roles.py` 定义 AI 角色
    - 定义 `MarketAnalyst` 角色用于市场分析
    - 定义 `RiskAdvisor` 角色用于风险评估
    - 定义 `ReportWriter` 角色用于报告生成
    - 每个角色配置专属系统提示词

18. 测试多 AI 调用链路
    - 使用 MCP 工具 `run_ai_pipeline` 执行测试任务
    - 检查 `logs/system.log` 确认路由和调用记录
    - 验证故障转移：手动禁用一个端点后确认自动切换

### 第四阶段：多通道信息推送配置

19. 配置邮件推送（SMTP）
    ```
    SMTP_HOST=smtp.gmail.com
    SMTP_PORT=587
    SMTP_USER=你的邮箱@gmail.com
    SMTP_PASS=你的应用专用密码
    SMTP_FROM=Heablcoin <你的邮箱@gmail.com>
    SMTP_TO=接收邮箱@example.com
    ```

20. 配置 Telegram 推送
    - 在 Telegram 中搜索 `@BotFather` 创建新机器人
    - 获取 Bot Token 并记录
    - 获取你的 Chat ID（向 `@userinfobot` 发送消息获取）
    - 在 `.env` 中配置
      ```
      TELEGRAM_BOT_TOKEN=你的Bot Token
      TELEGRAM_CHAT_ID=你的Chat ID
      ```

21. 配置 Discord 推送
    - 在 Discord 服务器设置中创建 Webhook
    - 复制 Webhook URL
    - 在 `.env` 中配置
      ```
      DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/xxx/xxx
      ```

22. 配置企业微信推送
    - 在企业微信管理后台创建自建应用
    - 获取 CorpID、AgentID、Secret
    - 在 `.env` 中配置
      ```
      WECOM_CORP_ID=你的企业ID
      WECOM_AGENT_ID=你的应用ID
      WECOM_SECRET=你的应用Secret
      ```

23. 配置钉钉推送
    - 在钉钉群设置中添加自定义机器人
    - 获取 Webhook URL 和加签密钥
    - 在 `.env` 中配置
      ```
      DINGTALK_WEBHOOK=https://oapi.dingtalk.com/robot/send?access_token=xxx
      DINGTALK_SECRET=SEC开头的密钥
      ```

24. 扩展 `utils/notifier.py` 添加新通道
    - 创建 `DiscordChannel` 类继承 `NotificationChannel`
    - 创建 `WeComChannel` 类继承 `NotificationChannel`
    - 创建 `DingTalkChannel` 类继承 `NotificationChannel`
    - 在 `Notifier` 初始化时根据环境变量自动注册可用通道

25. 配置通知规则和频率限制
    - 交易执行通知：立即推送到所有通道
    - 价格预警通知：每币种每小时最多 3 次
    - 系统异常通知：立即推送，相同错误码 10 分钟内不重复
    - 每日报告：每天固定时间推送一次

26. 测试多通道推送
    - 执行 `python tests/test_email_connection.py` 测试邮件
    - 使用 MCP 工具发送测试通知到各通道
    - 确认所有配置的通道均收到消息

### 第五阶段：四层联动验证

27. 验证完整链路：本地 MCP → 云端 Redis → AI 处理 → 多通道通知
    - 在 Claude Desktop 中发送指令："分析 BTC 走势并推送报告"
    - MCP Server 接收请求，发布任务到 Redis
    - 云端 Worker 消费任务，调用 AI 生成分析报告
    - 报告通过多通道推送到邮件和 Telegram

28. 设置云端定时任务
    - 在青龙面板或 crontab 配置定时执行
    - 每日 9:00 执行市场概览分析
    - 每日 21:00 执行当日交易总结
    - 每小时检查价格预警条件

29. 配置监控和告警
    - 设置 Redis 连接断开告警
    - 设置 AI API 调用失败率告警（超过 20% 触发）
    - 设置云端 Worker 心跳检测（超过 10 分钟无响应告警）

30. 编写运维文档并归档
    - 记录所有配置项和默认值
    - 记录故障排查步骤
    - 记录扩展新通道的方法
    - 将文档保存到 `docs/` 目录
