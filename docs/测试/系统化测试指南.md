# 系统化测试指南

本指南用于在你已经配置好 `.env`（所有变量参数已就绪）的前提下，对 Heablcoin 做“可重复、可验收、可回归”的系统化测试。

## 1. 测试目标

- 覆盖核心能力：MCP 启动、工具注册、市场分析、风控治理、云端任务、日志与审计。
- 覆盖边界情况：缺失配置、错误参数、超大输出、超时、外部依赖不可用。
- 产出一致：每次测试后能得到同样的结论与排障线索。

## 2. 前置条件

- Python：`3.10+`
- 依赖已安装：`pip install -r requirements.txt`
- `.env` 已配置（你已完成）
- 运行目录：项目根目录（含 `Heablcoin.py`）

## 3. 一键测试命令（推荐顺序）

1) 基础自检（命名/编码）

```bash
python scripts/check_naming.py
python scripts/check_utf8.py
```

2) 单元测试（不依赖外部服务，优先跑）

```bash
python tests/run_tests.py unit
```

3) 集成测试（覆盖 MCP stdio 启动、工具链路）

```bash
python tests/run_tests.py integration
```

4) 压力测试（会有并发/IO，建议确认机器状态后执行）

```bash
python tests/run_tests.py stress
```

5) 邮件链路测试（可能会发送真实邮件，仅在你确认邮箱配置正确时执行）

```bash
python tests/run_tests.py email
```

## 4. 测试矩阵（功能 x 场景）

### 4.1 MCP 启动与协议（P0）

- 目标：确保 MCP stdio 通道不被 stdout 污染，server 可启动并注册工具。
- 覆盖：`tests/test_mcp_stdio_startup.py`、`tests/test_integration_simple.py`

验收：
- 启动无 `Invalid JSON` / `Connection failed`
- `tests/run_tests.py integration` 全通过

### 4.2 工具注册与参数校验（P0）

- 目标：工具注册完整；参数校验在边界输入下可预期失败（而不是崩溃）。
- 覆盖：`tests/test_tool_registry.py`、`tests/test_validators.py`

验收：
- 对无效参数，返回结构化错误/异常被捕获

### 4.3 审计与备份（P0）

- 目标：MCP 调用审计日志与备份落盘在开启/关闭条件下都可工作。
- 覆盖：`tests/test_mcp_call_backups.py`

验收：
- 开启备份时生成备份文件（目录被 `.gitignore` 忽略）
- 关闭备份时不生成文件但调用仍成功

### 4.4 云端任务与队列（P1）

- 目标：任务发布/查询/执行状态机正确；Redis 可用时走 Redis，Redis 不可用时降级可预期。
- 覆盖：`tests/test_task_executor.py`、`tests/test_stress_task_executor.py`

验收：
- 单测通过
- 并发压力测试不写坏 JSON，不死锁

### 4.5 风控/策略/治理（P1）

- 覆盖：`tests/test_risk_management.py`、`tests/test_risk_budget.py`、`tests/test_risk_extensions.py`、`tests/test_strategy_registry.py`、`tests/test_governance_monitors.py`

验收：
- 风控边界（限额/熔断/预算）在异常输入下不放行

### 4.6 外部通道（可选）

- 邮件：`tests/test_email_connection.py`
- 飞书：`tests/test_feishu_push.py`

验收：
- 在配置齐全时通过；在配置缺失时应明确失败原因（不崩溃）

## 5. 失败排查（统一顺序）

1) 先看测试输出：定位失败文件与断言信息。
2) 再看日志目录：`logs/`（若启用结构化日志）
3) 检查 `.env`：缺失/拼写错误/值类型错误。
4) 若与编码相关：确保 `PYTHONUTF8=1`、`PYTHONIOENCODING=utf-8`。

## 6. 产出与留痕（建议）

每次全量验证完成后：

- 在 `历史记录.json` 追加一次“测试与验收完成”的记录
- 在 `任务进度.json` 更新对应项目/任务状态
- 如发现问题：在 `lesson/` 记录复盘条目
