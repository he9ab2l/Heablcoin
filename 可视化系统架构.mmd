%% 可视化系统架构 - 自动生成（更新时间：2025-12-18 21:37:17）
%% 可直接导入 https://www.mermaidchart.com/
%% Heablcoin - MCP 驱动的加密交易系统（src 分层架构）

graph TB
    classDef datasource fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    classDef core fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#4a148c
    classDef tools fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#e65100
    classDef skills fill:#e8f5e9,stroke:#388e3c,stroke-width:2px,color:#1b5e20
    classDef utils fill:#fffde7,stroke:#fbc02d,stroke-width:2px,color:#f57f17
    classDef storage fill:#e0f2f1,stroke:#00796b,stroke-width:2px,color:#004d40
    classDef terminal fill:#eceff1,stroke:#546e7a,stroke-width:2px,color:#263238

    SystemArchitecture["Heablcoin<br/>MCP Trading System"]

    subgraph Entry["入口 Entry"]
        ENTRY["Heablcoin.py（稳定入口包装器）"]
        SERVER["src/core/server.py（FastMCP 服务端）"]
        ENTRY --> SERVER
    end

    subgraph DataSources["数据源层 DataSources"]
        DS_Config[".env / 环境变量"]
        DS_Exchange["交易所 API（Binance Testnet/Mainnet via CCXT）"]
        DS_Redis["Redis（任务队列/缓存）"]
        DS_LLM["LLM Providers（OpenAI/DeepSeek/Claude/Gemini/...）"]
        DS_Notify["通知通道（SMTP/Server酱/飞书/...）"]
    end

    subgraph Core["核心层 Core（src/core）"]
        CORE_Path["path_setup.py（sys.path 启动）"]
        CORE_Exchange["exchange.py（交易所连接池）"]
        CORE_McpSafety["mcp_safety.py（工具安全封装）"]
        CORE_ToolRegistry["tool_registry.py（工具注册表/开关）"]
        CORE_Cloud["cloud/*（任务/调度/队列）"]
        CORE_Orch["orchestration/*（多模型路由/编排）"]
    end

    subgraph ToolsLayer["工具层 Tools（src/tools）"]
        T_Market["market_analysis_tools.py"]
        T_Personal["personal_analytics_tools.py"]
        T_Learning["learning_tools.py"]
        T_Orch["orchestration_tools.py"]
        T_Cloud["cloud_tools.py"]
        T_Admin["admin_tools.py（工具开关管理）"]
    end

    subgraph SkillsLayer["技能/领域层 Skills（src/skills）"]
        SK_Market["market_analysis/*"]
        SK_Personal["personal_analytics/*"]
        SK_Learning["learning/*"]
        SK_Report["report/*（含 flexible_report）"]
        SK_Data["data/*"]
    end

    subgraph UtilsLayer["通用工具 Utils（src/utils）"]
        U_Paths["project_paths.py（仓库根路径）"]
        U_Env["env_helpers.py（env 读取/解析）"]
        U_Logger["smart_logger.py"]
        U_Cache["smart_cache.py"]
        U_Risk["risk_management.py"]
        U_ExchangeAdapter["exchange_adapter.py"]
        U_Notifier["notifier.py"]
    end

    subgraph StorageLayer["存储适配 Storage（src/storage）"]
        ST_File["file_adapter.py"]
        ST_Redis["redis_adapter.py"]
        ST_Email["email_adapter.py"]
        ST_Notion["notion_adapter.py"]
    end

    subgraph Documentation["文档层 Documentation"]
        DOC_User["docs/user/*"]
        DOC_Dev["docs/developer/*"]
        DOC_Lesson["lesson/*"]
    end

    subgraph DevOps["开发运维 DevOps"]
        DEV_GpSh["gp.sh（提交推送脚本）"]
        DEV_GpPs1["gp.ps1（Windows 提交推送脚本）"]
        DEV_SecretScan["scripts/scan_secrets.py（敏感信息扫描）"]
        DEV_CI[".github/workflows/tests.yml（CI 测试）"]
    end

    subgraph Terminals["客户端/终端 Terminals"]
        UT_Claude["Claude Desktop（MCP Client）"]
        UT_Windsurf["Windsurf（MCP Client）"]
        UT_Test["Heablcoin-test.py（终端自检）"]
        UT_Qinglong["qinglong_worker.py（青龙 Worker）"]
    end

    %% 主要数据流/调用链
    DS_Config --> SERVER
    SERVER --> ToolsLayer
    SERVER --> CORE_McpSafety
    ToolsLayer --> SkillsLayer
    ToolsLayer --> UtilsLayer
    SkillsLayer --> UtilsLayer
    ToolsLayer --> StorageLayer
    SkillsLayer --> StorageLayer

    CORE_McpSafety --> CORE_ToolRegistry
    ToolsLayer --> CORE_ToolRegistry

    DS_Exchange --> U_ExchangeAdapter
    DS_Redis --> ST_Redis
    DS_LLM --> CORE_Orch
    DS_Notify --> ST_Email

    SERVER -->|"MCP JSON-RPC"| UT_Claude
    SERVER -->|"MCP JSON-RPC"| UT_Windsurf
    UT_Test --> SERVER
    UT_Qinglong --> CORE_Cloud

    %% 样式应用
    class DS_Config,DS_Exchange,DS_Redis,DS_LLM,DS_Notify datasource
    class CORE_Path,CORE_Exchange,CORE_McpSafety,CORE_ToolRegistry,CORE_Cloud,CORE_Orch core
    class T_Market,T_Personal,T_Learning,T_Orch,T_Cloud,T_Admin tools
    class SK_Market,SK_Personal,SK_Learning,SK_Report,SK_Data skills
    class U_Paths,U_Env,U_Logger,U_Cache,U_Risk,U_ExchangeAdapter,U_Notifier utils
    class ST_File,ST_Redis,ST_Email,ST_Notion storage
    class ENTRY,SERVER,SystemArchitecture terminal
    class UT_Claude,UT_Windsurf,UT_Test,UT_Qinglong terminal
    class DOC_User,DOC_Dev,DOC_Lesson terminal
    class DEV_GpSh,DEV_GpPs1,DEV_SecretScan,DEV_CI terminal
