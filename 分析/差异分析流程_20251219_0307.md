# 差异分析：历史记录编码修复 (20251219_0307)

- 提交基线: 1f3e998716d0fcb69832af3db3a8780088ce2eff
- 当前分支: v2test（未提交修改）
- 触发原因: unit suite 中的 test_project_records 检测到 `历史记录.json` 出现 ASCII `?` 占位符

## 1. 现象
- `python tests/run_tests.py unit` 在“项目记录文件回归测试”阶段报 “含 ASCII '?'”。
- `历史记录.json` 中多条记录被 `?` 污染，新治理条目缺失。

## 2. 根因
- 早期在 Windows 控制台直接输入中文，编码回退成 `?`；合入治理功能时未同步旧记录，导致 JSON 与日志脱节。
- `任务.txt` 虽提示“禁止乱码”，但缺少自动校验，直到测试命中。

## 3. 处理动作
1. 用 Python 生成器重写 `历史记录.json`：保留 12-18 里程碑，补记 12-19 任务发布/量化研究/治理升级。
2. 采用 ASCII 安全输出（必要时可 `ensure_ascii=True`），避免跨终端再次劣化；中文路径统一用 `\\uXXXX` 写入。
3. 修复 `_按时间轴_`、`审计专家系统`、`API参考`、`任务.txt` 等字段的转义残留，清除所有 `?`。
4. 重跑 `python tests/run_tests.py unit`、`python scripts/check_naming.py`，验证记录文件与命名规范。
5. 新增本分析文档，作为编码事故的复盘材料。

## 4. 验证
- `python tests/run_tests.py unit` ✅ 18/18 通过。
- `python scripts/check_naming.py` ✅ 通过。
- `Select-String -Pattern '\\?' 历史记录.json` ✅ 无命中。

## 5. 后续建议
- 在 CI 中追加“记录文件 UTF-8 检查”和 `scripts/scan_secrets.py`，放在命名检查之后执行。
- 新增功能前先更新 `历史记录.json` / `任务.txt`，再改代码，保证记录与实现同步。
- Windows 侧一律用脚本写中文内容，禁止在控制台直接输入，复用本次的写入函数或模板。
