# Heablcoin 项目基线分析（只读学习）

> 本文件为长期维护入口（无时间戳）。
> 
> - 历史快照：`分析/基线分析_20251219_010259.md`
> - 快照 Git HEAD：`20e9affa75619fdcbb863d5c837a7dd3f80743e4`
> - 快照分支：`v2test`

## 1. 项目定位与目标

Heablcoin 是一个 **面向 MCP（Model Context Protocol）的加密货币交易/分析服务端**，供 Claude Desktop / Windsurf 等 MCP Client 通过 JSON-RPC 调用。

项目核心目标：
- 提供 **市场分析**（技术/信号/情绪/结构等模块化输出）
- 提供 **个人绩效分析**（基于成交记录的多维统计）
- 提供 **任务系统**（异步发布/状态查询/可回调）
- 提供 **通知与报告**（SMTP 邮件、可插拔 storage）
- 提供 **学习训练/纪律工具**（交易前审计、盘中陪练、历史盲测、习惯画像等）
- 提供 **多模型 AI 编排/路由**（按角色路由到不同 provider）

## 2. 入口与运行方式

### 2.1 MCP 入口
- 稳定入口：`Heablcoin.py`
  - 作用：兼容旧路径，真正实现迁移到 `src/core/server.py`
  - 行为：将 `src/` 加入 `sys.path`，然后 `from core.server import *`，最后 `mcp.run()`

### 2.2 MCP stdout 约束（关键工程约束）
- MCP/JSON-RPC 通道依赖 stdout
- `src/core/server.py` 在启动时将 `sys.stdout = sys.stderr`，避免任何 `print()` 污染协议
- 工具函数统一用 `core.mcp_safety.mcp_tool_safe` 封装：
  - 捕获异常，防止 Server 崩溃
  - `redirect_stdout(sys.stderr)` 二次兜底
  - 支持工具“软禁用”（tool registry）

### 2.3 用户侧使用（概要）
- 安装：`pip install -r requirements.txt`
- 配置：复制 `.env.example` 为 `.env` 并填入 Binance/SMTP/AI/Redis 等配置
- Claude Desktop：在配置中指向 `python D:/MCP/Heablcoin.py`
- 终端：
  - 快速自检脚本：`python Heablcoin-test.py --quick`
  - 测试套件（示例）：`python tests/run_tests.py unit`

## 3. 目录结构与职责（高层）

### 3.1 根目录（部分）
- `Heablcoin.py`: MCP 启动包装器
- `Heablcoin-test.py`: 终端自检脚本（快速验证）
- `API_SPEC.md`: MCP Tools/API 规格摘要
- `DEPLOY_GUIDE.md`: 部署运维（pm2/Redis/worker/webhook）
- `docs/`: 用户/开发者文档
- `src/`: 核心代码
- `tests/`: 回归测试
- `qinglong_worker.py`: 青龙/云端监控 worker（Redis 监控任务轮询）
- `分析/`: 分析输出目录（本文件为无时间戳入口）

### 3.2 `src/` 分层
- `src/core/`: 运行时核心（MCP server、exchange、工具安全、任务系统、AI 编排）
- `src/tools/`: MCP tool 注册层（把 skills/core 能力注册到 FastMCP）
- `src/skills/`: 业务能力实现层（市场分析、个人分析、学习训练、报告生成等）
- `src/storage/`: 存储适配器层（file/notion/email/redis）
- `src/utils/`: 通用组件（env helpers、logger、cache、风控、校验器等）

## 4. 核心数据流（简化）

### 4.1 MCP 调用主链路
1. MCP Client 发起 JSON-RPC tool 调用
2. `src/core/server.py` 的 `FastMCP("Heablcoin")` 接收
3. `src/tools/*_tools.py` 已在启动时注册 tool
4. tool 通过 `mcp_tool_safe` 执行实际逻辑
5. skills 层获取数据（ccxt/文件/数据库/Redis/Notion 等）并返回 markdown/json

### 4.2 市场数据流（MarketAnalyzer）
- `tools/market_analysis_tools.py:get_market_analysis_modular`
- `skills/market_analysis/core.py:MarketAnalyzer`
  - `DataProvider.instance()` 拉取 OHLCV/ticker
  - `AnalyzerRegistry` 选择模块（默认启用 `technical`/`signals`；`sentiment`/`patterns`/`structure` 默认关闭）
  - 输出格式：`skills/market_analysis/report_generator.py` 负责 `markdown/json` 格式化

### 4.3 个人分析数据流（PersonalAnalyzer）
- `tools/personal_analytics_tools.py`
- `skills/personal_analytics/core.py:PersonalAnalyzer`
  - 数据源：`skills/personal_analytics/data_provider.py:read_trade_history`（交易历史）
  - 模块化分析：`performance/risk/attribution/behavior/portfolio/costs/periods/sessions/journal/funds`
  - 输出格式：markdown 或 JSON

### 4.4 任务系统数据流（异步）
- MCP tool：`publish_task` / `get_task_status` / `list_enhanced_tasks` 等（见 `src/tools/cloud_tools.py`）
- 执行器：`src/core/cloud/task_executor.py`
  - `start_executor()` 在 `core/server.py` 启动时可自动拉起（`ENABLE_TASK_EXECUTOR`）
  - `EnhancedCloudTaskPublisher` 提供持久化队列与状态
  - 处理器 `TaskHandler` 分派到：市场分析、AI 调用、报告生成、存储保存等
  - 支持：依赖、重试、过期、回调 URL（webhook）

### 4.5 云端哨兵/青龙 Worker
- `tools/orchestration_tools.py:set_cloud_sentry` 将监控任务写入 Redis 队列（`core.cloud.task_manager.enqueue_monitor_task`）
- `qinglong_worker.py` 轮询 Redis，满足 `price <|<=|>|>= X` 条件后发邮件提醒

## 5. MCP Tool 面（按注册点归类）

### 5.1 市场分析
- `get_market_analysis_modular(symbol,timeframe,modules,return_format)`

### 5.2 个人分析
- `get_personal_analysis(modules,limit,initial_capital,return_format)`
- `get_full_personal_analysis(initial_capital,return_format)`
- `get_portfolio_analysis(return_format)`
- `get_period_performance(period,return_format)`
- `get_trading_session_analysis(return_format)`
- `get_cost_analysis(return_format)`
- `add_trade_journal_note(order_id,note,tags)`
- `record_funds_flow(amount,record_type,currency,note,date)`
- `search_trade_history(symbol,side,start_date,end_date,limit)`
- `list_personal_analysis_modules()`

### 5.3 学习/训练
- `get_learning_catalog()`
- `start_learning_session(kind,...)` / `submit_learning_answer(session_id,answer,ai_enhance,tone)`
- 纪律/拦截配置：`get_execution_guard_settings()` / `set_execution_guard_settings(...)`
- 交易前审计：`audit_trade_reason` / `calculate_risk_reward` / `check_trend_alignment` / `check_fomo`
- 盘中陪练/工具：`hunt_patterns` / `get_profit_protection_advice` / `analyze_loss` / `simulate_what_if` / `backtest_strategy` 等
- 成长画像：`log_trade_decision` / `get_trade_journal` / `record_bad_habit` / `get_habit_warnings` / `get_trader_level` / `record_trade_result`
- 辅助：`calculate_volatility_size` / `check_market_events` / `quick_market_overview`

### 5.4 AI 编排/多模型路由
- `ai_run_pipeline(task,user_input,context)`
- `ai_enhance_output(content,tone,context)`
- `ai_provider_snapshot()`
- `ai_call_role(role,prompt,context,max_tokens,temperature,forced_endpoint)`
- `ai_reason/ai_write/ai_remember/ai_research/ai_critique/ai_list_roles`
- `consult_external_expert(query,model,context)`（第二意见）

### 5.5 Cloud/任务
- `start_cloud_scheduler()` / `cloud_scheduler_snapshot()` / `trigger_cloud_queue()`
- `publish_cloud_task` / `list_cloud_tasks`
- `publish_enhanced_task` / `list_enhanced_tasks` / `get_enhanced_task_stats` / `retry_failed_task` / `cleanup_expired_tasks`
- `publish_task` / `get_task_status`
- API endpoint 管理：`add_api_endpoint` / `get_api_manager_stats` / `reset_api_stats`

### 5.6 管理工具
- `list_tools()` / `set_tool_enabled(tool_name,enabled)` / `reset_tool_overrides()`

## 6. 项目输出/数据文件（用户可感知）
- 交易记录：`trade_history.csv`（同时存在 SQLite：`data/trades.db` 或同类路径）
- 日志：`logs/server_debug.log`（以及 smart logger 多通道）
- 分析报告：`reports/analysis_reports/YYYYMMDD/`
- 灵活报告备份：`reports/flexible_report/YYYYMMDD/`
- 用户查询备份：`reports/query_backups/YYYYMMDD/`
- 学习会话存储：位于 `skills/learning/storage.py` 管理的本地持久化

## 7. 优点（当前观察）
- **分层清晰**：`tools`（接口注册）/`skills`（业务）/`core`（运行时）/`storage`/`utils`
- **MCP 工程约束意识强**：stdout 污染防护 + tool 安全封装
- **模块化分析**：市场分析与个人分析均为可插拔模块，默认模块与关闭模块分明
- **任务系统较完整**：支持优先级、依赖、重试、过期、回调
- **可观测性导向**：smart logger / smart cache
- **可扩展性**：多模型路由、存储适配器、API endpoint 管理

## 8. 缺陷/风险点（当前观察，后续需精读验证）

### 8.1 仓库状态风险
- 当前工作区若存在大量未提交变更，说明目录不是“干净基线”
- 本文为只读分析入口；如需严格回溯，请以 git commit（HEAD）为准

### 8.2 入口与依赖
- `requirements.txt` 未 pin 版本（`mcp/ccxt/pandas/numpy/...`）
  - 风险：环境升级可能导致行为差异

### 8.3 安全与误操作风险
- 交易相关能力存在，但实际风控细节（白名单/限额/下单前校验/测试网切换）需要进一步核查

### 8.4 任务/并发一致性
- `TaskExecutor` 为线程轮询模型，状态更新与重试逻辑依赖 `EnhancedCloudTaskPublisher` 的一致性实现
- 回调签名校验、幂等、失败重放等需要进一步核对实现文件

### 8.5 worker/Redis 依赖
- `qinglong_worker.py` 依赖 Redis + `Heablcoin` 内的通知/交易所能力，部署环境容易出现路径/依赖/凭证问题

## 9. 下一步只读分析计划
- 精读 `src/core/server.py` 的交易执行/风控工具列表、账户/仓位/订单工具、报告生成与落盘路径
- 精读 `src/core/orchestration/*`：provider 实现、路由规则、环境变量矩阵
- 精读 `src/core/cloud/enhanced_publisher.py`：任务持久化格式、回调签名/重试/过期
- 精读 `src/storage/*`：Notion/Email/File/Redis 的统一接口与错误处理
