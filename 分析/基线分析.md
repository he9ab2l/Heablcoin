# Heablcoin é¡¹ç›®åŸºçº¿åˆ†æ

## 1. é¡¹ç›®å®šä½ä¸ç›®æ ‡

Heablcoin æ˜¯ä¸€ä¸ª **é¢å‘ MCPï¼ˆModel Context Protocolï¼‰çš„åŠ å¯†è´§å¸äº¤æ˜“/åˆ†ææœåŠ¡ç«¯**ï¼Œä¾› Claude Desktop / Windsurf ç­‰ MCP Client é€šè¿‡ JSON-RPC è°ƒç”¨ã€‚

é¡¹ç›®æ ¸å¿ƒç›®æ ‡ï¼š
- æä¾› **å¸‚åœºåˆ†æ**ï¼ˆæŠ€æœ¯/ä¿¡å·/æƒ…ç»ª/ç»“æ„ç­‰æ¨¡å—åŒ–è¾“å‡ºï¼‰
- æä¾› **ä¸ªäººç»©æ•ˆåˆ†æ**ï¼ˆåŸºäºæˆäº¤è®°å½•çš„å¤šç»´ç»Ÿè®¡ï¼‰
- æä¾› **ä»»åŠ¡ç³»ç»Ÿ**ï¼ˆå¼‚æ­¥å‘å¸ƒ/çŠ¶æ€æŸ¥è¯¢/å¯å›è°ƒï¼‰
- æä¾› **é€šçŸ¥ä¸æŠ¥å‘Š**ï¼ˆSMTP é‚®ä»¶ã€å¯æ’æ‹” storageï¼‰
- æä¾› **å­¦ä¹ è®­ç»ƒ/çºªå¾‹å·¥å…·**ï¼ˆäº¤æ˜“å‰å®¡è®¡ã€ç›˜ä¸­é™ªç»ƒã€å†å²ç›²æµ‹ã€ä¹ æƒ¯ç”»åƒç­‰ï¼‰
- æä¾› **å¤šæ¨¡å‹ AI ç¼–æ’/è·¯ç”±**ï¼ˆæŒ‰è§’è‰²è·¯ç”±åˆ°ä¸åŒ providerï¼‰

## 2. å…¥å£ä¸è¿è¡Œæ–¹å¼

### 2.1 MCP å…¥å£
- ç¨³å®šå…¥å£ï¼š`Heablcoin.py`
  - ä½œç”¨ï¼šå…¼å®¹æ—§è·¯å¾„ï¼ŒçœŸæ­£å®ç°è¿ç§»åˆ° `src/core/server.py`
  - è¡Œä¸ºï¼šå°† `src/` åŠ å…¥ `sys.path`ï¼Œç„¶å `from core.server import *`ï¼Œæœ€å `mcp.run()`

### 2.2 MCP stdout çº¦æŸï¼ˆå…³é”®å·¥ç¨‹çº¦æŸï¼‰
- MCP/JSON-RPC é€šé“ä¾èµ– stdout
- `src/core/server.py` åœ¨å¯åŠ¨æ—¶å°† `sys.stdout = sys.stderr`ï¼Œé¿å…ä»»ä½• `print()` æ±¡æŸ“åè®®
- å·¥å…·å‡½æ•°ç»Ÿä¸€ç”¨ `core.mcp_safety.mcp_tool_safe` å°è£…ï¼š
  - æ•è·å¼‚å¸¸ï¼Œé˜²æ­¢ Server å´©æºƒ
  - `redirect_stdout(sys.stderr)` äºŒæ¬¡å…œåº•
  - æ”¯æŒå·¥å…·â€œè½¯ç¦ç”¨â€ï¼ˆtool registryï¼‰

### 2.3 ç”¨æˆ·ä¾§ä½¿ç”¨ï¼ˆæ¦‚è¦ï¼‰
- å®‰è£…ï¼š`pip install -r requirements.txt`
- é…ç½®ï¼šå¤åˆ¶ `.env.example` ä¸º `.env` å¹¶å¡«å…¥ Binance/SMTP/AI/Redis ç­‰é…ç½®
- Claude Desktopï¼šåœ¨é…ç½®ä¸­æŒ‡å‘ `python D:/MCP/Heablcoin.py`
- ç»ˆç«¯ï¼š
  - å¿«é€Ÿè‡ªæ£€è„šæœ¬ï¼š`python Heablcoin-test.py --quick`
  - æµ‹è¯•å¥—ä»¶ï¼ˆç¤ºä¾‹ï¼‰ï¼š`python tests/run_tests.py unit`

## 3. ç›®å½•ç»“æ„ä¸èŒè´£ï¼ˆé«˜å±‚ï¼‰

### 3.1 æ ¹ç›®å½•ï¼ˆéƒ¨åˆ†ï¼‰
- `Heablcoin.py`: MCP å¯åŠ¨åŒ…è£…å™¨
- `Heablcoin-test.py`: ç»ˆç«¯è‡ªæ£€è„šæœ¬ï¼ˆå¿«é€ŸéªŒè¯ï¼‰
- `API_SPEC.md`: MCP Tools/API è§„æ ¼æ‘˜è¦
- `DEPLOY_GUIDE.md`: éƒ¨ç½²è¿ç»´ï¼ˆpm2/Redis/worker/webhookï¼‰
- `docs/`: ç”¨æˆ·/å¼€å‘è€…æ–‡æ¡£
- `src/`: æ ¸å¿ƒä»£ç 
- `tests/`: å›å½’æµ‹è¯•
- `qinglong_worker.py`: é’é¾™/äº‘ç«¯ç›‘æ§ workerï¼ˆRedis ç›‘æ§ä»»åŠ¡è½®è¯¢ï¼‰
- `åˆ†æ/`: åˆ†æè¾“å‡ºç›®å½•ï¼ˆæœ¬æ–‡ä»¶ä¸ºæ— æ—¶é—´æˆ³å…¥å£ï¼‰

### 3.2 `src/` åˆ†å±‚
- `src/core/`: è¿è¡Œæ—¶æ ¸å¿ƒï¼ˆMCP serverã€exchangeã€å·¥å…·å®‰å…¨ã€ä»»åŠ¡ç³»ç»Ÿã€AI ç¼–æ’ï¼‰
- `src/tools/`: MCP tool æ³¨å†Œå±‚ï¼ˆæŠŠ skills/core èƒ½åŠ›æ³¨å†Œåˆ° FastMCPï¼‰
- `src/skills/`: ä¸šåŠ¡èƒ½åŠ›å®ç°å±‚ï¼ˆå¸‚åœºåˆ†æã€ä¸ªäººåˆ†æã€å­¦ä¹ è®­ç»ƒã€æŠ¥å‘Šç”Ÿæˆç­‰ï¼‰
- `src/storage/`: å­˜å‚¨é€‚é…å™¨å±‚ï¼ˆfile/notion/email/redisï¼‰
- `src/utils/`: é€šç”¨ç»„ä»¶ï¼ˆenv helpersã€loggerã€cacheã€é£æ§ã€æ ¡éªŒå™¨ç­‰ï¼‰

## 4. æ ¸å¿ƒæ•°æ®æµï¼ˆç®€åŒ–ï¼‰

### 4.1 MCP è°ƒç”¨ä¸»é“¾è·¯
1. MCP Client å‘èµ· JSON-RPC tool è°ƒç”¨
2. `src/core/server.py` çš„ `FastMCP("Heablcoin")` æ¥æ”¶
3. `src/tools/*_tools.py` å·²åœ¨å¯åŠ¨æ—¶æ³¨å†Œ tool
4. tool é€šè¿‡ `mcp_tool_safe` æ‰§è¡Œå®é™…é€»è¾‘
5. skills å±‚è·å–æ•°æ®ï¼ˆccxt/æ–‡ä»¶/æ•°æ®åº“/Redis/Notion ç­‰ï¼‰å¹¶è¿”å› markdown/json

### 4.2 å¸‚åœºæ•°æ®æµï¼ˆMarketAnalyzerï¼‰
- `tools/market_analysis_tools.py:get_market_analysis_modular`
- `skills/market_analysis/core.py:MarketAnalyzer`
  - `DataProvider.instance()` æ‹‰å– OHLCV/ticker
  - `AnalyzerRegistry` é€‰æ‹©æ¨¡å—ï¼ˆé»˜è®¤å¯ç”¨ `technical`/`signals`ï¼›`sentiment`/`patterns`/`structure` é»˜è®¤å…³é—­ï¼‰
  - è¾“å‡ºæ ¼å¼ï¼š`skills/market_analysis/report_generator.py` è´Ÿè´£ `markdown/json` æ ¼å¼åŒ–

### 4.3 ä¸ªäººåˆ†ææ•°æ®æµï¼ˆPersonalAnalyzerï¼‰
- `tools/personal_analytics_tools.py`
- `skills/personal_analytics/core.py:PersonalAnalyzer`
  - æ•°æ®æºï¼š`skills/personal_analytics/data_provider.py:read_trade_history`ï¼ˆäº¤æ˜“å†å²ï¼‰
  - æ¨¡å—åŒ–åˆ†æï¼š`performance/risk/attribution/behavior/portfolio/costs/periods/sessions/journal/funds`
  - è¾“å‡ºæ ¼å¼ï¼šmarkdown æˆ– JSON

### 4.4 ä»»åŠ¡ç³»ç»Ÿæ•°æ®æµï¼ˆå¼‚æ­¥ï¼‰
- MCP toolï¼š`publish_task` / `get_task_status` / `list_enhanced_tasks` ç­‰ï¼ˆè§ `src/tools/cloud_tools.py`ï¼‰
- æ‰§è¡Œå™¨ï¼š`src/core/cloud/task_executor.py`
  - `start_executor()` åœ¨ `core/server.py` å¯åŠ¨æ—¶å¯è‡ªåŠ¨æ‹‰èµ·ï¼ˆ`ENABLE_TASK_EXECUTOR`ï¼‰
  - `EnhancedCloudTaskPublisher` æä¾›æŒä¹…åŒ–é˜Ÿåˆ—ä¸çŠ¶æ€
  - å¤„ç†å™¨ `TaskHandler` åˆ†æ´¾åˆ°ï¼šå¸‚åœºåˆ†æã€AI è°ƒç”¨ã€æŠ¥å‘Šç”Ÿæˆã€å­˜å‚¨ä¿å­˜ç­‰
  - æ”¯æŒï¼šä¾èµ–ã€é‡è¯•ã€è¿‡æœŸã€å›è°ƒ URLï¼ˆwebhookï¼‰

### 4.5 äº‘ç«¯å“¨å…µ/é’é¾™ Worker
- `tools/orchestration_tools.py:set_cloud_sentry` å°†ç›‘æ§ä»»åŠ¡å†™å…¥ Redis é˜Ÿåˆ—ï¼ˆ`core.cloud.task_manager.enqueue_monitor_task`ï¼‰
- `qinglong_worker.py` è½®è¯¢ Redisï¼Œæ»¡è¶³ `price <|<=|>|>= X` æ¡ä»¶åå‘é‚®ä»¶æé†’

## 5. MCP Tool é¢ï¼ˆæŒ‰æ³¨å†Œç‚¹å½’ç±»ï¼‰

### 5.1 å¸‚åœºåˆ†æ
- `get_market_analysis_modular(symbol,timeframe,modules,return_format)`

### 5.2 ä¸ªäººåˆ†æ
- `get_personal_analysis(modules,limit,initial_capital,return_format)`
- `get_full_personal_analysis(initial_capital,return_format)`
- `get_portfolio_analysis(return_format)`
- `get_period_performance(period,return_format)`
- `get_trading_session_analysis(return_format)`
- `get_cost_analysis(return_format)`
- `add_trade_journal_note(order_id,note,tags)`
- `record_funds_flow(amount,record_type,currency,note,date)`
- `search_trade_history(symbol,side,start_date,end_date,limit)`
- `list_personal_analysis_modules()`

### 5.3 å­¦ä¹ /è®­ç»ƒ
- `get_learning_catalog()`
- `start_learning_session(kind,...)` / `submit_learning_answer(session_id,answer,ai_enhance,tone)`
- çºªå¾‹/æ‹¦æˆªé…ç½®ï¼š`get_execution_guard_settings()` / `set_execution_guard_settings(...)`
- äº¤æ˜“å‰å®¡è®¡ï¼š`audit_trade_reason` / `calculate_risk_reward` / `check_trend_alignment` / `check_fomo`
- ç›˜ä¸­é™ªç»ƒ/å·¥å…·ï¼š`hunt_patterns` / `get_profit_protection_advice` / `analyze_loss` / `simulate_what_if` / `backtest_strategy` ç­‰
- æˆé•¿ç”»åƒï¼š`log_trade_decision` / `get_trade_journal` / `record_bad_habit` / `get_habit_warnings` / `get_trader_level` / `record_trade_result`
- è¾…åŠ©ï¼š`calculate_volatility_size` / `check_market_events` / `quick_market_overview`

### 5.4 AI ç¼–æ’/å¤šæ¨¡å‹è·¯ç”±
- `ai_run_pipeline(task,user_input,context)`
- `ai_enhance_output(content,tone,context)`
- `ai_provider_snapshot()`
- `ai_call_role(role,prompt,context,max_tokens,temperature,forced_endpoint)`
- `ai_reason/ai_write/ai_remember/ai_research/ai_critique/ai_list_roles`
- `consult_external_expert(query,model,context)`ï¼ˆç¬¬äºŒæ„è§ï¼‰

### 5.5 Cloud/ä»»åŠ¡
- `start_cloud_scheduler()` / `cloud_scheduler_snapshot()` / `trigger_cloud_queue()`
- `publish_cloud_task` / `list_cloud_tasks`
- `publish_enhanced_task` / `list_enhanced_tasks` / `get_enhanced_task_stats` / `retry_failed_task` / `cleanup_expired_tasks`
- `publish_task` / `get_task_status`
- API endpoint ç®¡ç†ï¼š`add_api_endpoint` / `get_api_manager_stats` / `reset_api_stats`

### 5.6 ç®¡ç†å·¥å…·
- `list_tools()` / `set_tool_enabled(tool_name,enabled)` / `reset_tool_overrides()`

## 6. é¡¹ç›®è¾“å‡º/æ•°æ®æ–‡ä»¶ï¼ˆç”¨æˆ·å¯æ„ŸçŸ¥ï¼‰
- äº¤æ˜“è®°å½•ï¼š`trade_history.csv`ï¼ˆåŒæ—¶å­˜åœ¨ SQLiteï¼š`data/trades.db` æˆ–åŒç±»è·¯å¾„ï¼‰
- æ—¥å¿—ï¼š`logs/server_debug.log`ï¼ˆä»¥åŠ smart logger å¤šé€šé“ï¼‰
- åˆ†ææŠ¥å‘Šï¼š`reports/analysis_reports/YYYYMMDD/`
- çµæ´»æŠ¥å‘Šå¤‡ä»½ï¼š`reports/flexible_report/YYYYMMDD/`
- ç”¨æˆ·æŸ¥è¯¢å¤‡ä»½ï¼š`reports/query_backups/YYYYMMDD/`
- å­¦ä¹ ä¼šè¯å­˜å‚¨ï¼šä½äº `skills/learning/storage.py` ç®¡ç†çš„æœ¬åœ°æŒä¹…åŒ–

## 7. ä¼˜ç‚¹ï¼ˆå½“å‰è§‚å¯Ÿï¼‰
- **åˆ†å±‚æ¸…æ™°**ï¼š`tools`ï¼ˆæ¥å£æ³¨å†Œï¼‰/`skills`ï¼ˆä¸šåŠ¡ï¼‰/`core`ï¼ˆè¿è¡Œæ—¶ï¼‰/`storage`/`utils`
- **MCP å·¥ç¨‹çº¦æŸæ„è¯†å¼º**ï¼šstdout æ±¡æŸ“é˜²æŠ¤ + tool å®‰å…¨å°è£…
- **æ¨¡å—åŒ–åˆ†æ**ï¼šå¸‚åœºåˆ†æä¸ä¸ªäººåˆ†æå‡ä¸ºå¯æ’æ‹”æ¨¡å—ï¼Œé»˜è®¤æ¨¡å—ä¸å…³é—­æ¨¡å—åˆ†æ˜
- **ä»»åŠ¡ç³»ç»Ÿè¾ƒå®Œæ•´**ï¼šæ”¯æŒä¼˜å…ˆçº§ã€ä¾èµ–ã€é‡è¯•ã€è¿‡æœŸã€å›è°ƒ
- **å¯è§‚æµ‹æ€§å¯¼å‘**ï¼šsmart logger / smart cache
- **å¯æ‰©å±•æ€§**ï¼šå¤šæ¨¡å‹è·¯ç”±ã€å­˜å‚¨é€‚é…å™¨ã€API endpoint ç®¡ç†

## 8. ç¼ºé™·/é£é™©ç‚¹ï¼ˆå½“å‰è§‚å¯Ÿï¼Œåç»­éœ€ç²¾è¯»éªŒè¯ï¼‰

### 8.1 ä»“åº“çŠ¶æ€é£é™©
- å½“å‰å·¥ä½œåŒºè‹¥å­˜åœ¨å¤§é‡æœªæäº¤å˜æ›´ï¼Œè¯´æ˜ç›®å½•ä¸æ˜¯â€œå¹²å‡€åŸºçº¿â€
- æœ¬æ–‡ä¸ºåªè¯»åˆ†æå…¥å£ï¼›å¦‚éœ€ä¸¥æ ¼å›æº¯ï¼Œè¯·ä»¥ git commitï¼ˆHEADï¼‰ä¸ºå‡†

### 8.2 å…¥å£ä¸ä¾èµ–
- `requirements.txt` æœª pin ç‰ˆæœ¬ï¼ˆ`mcp/ccxt/pandas/numpy/...`ï¼‰
  - é£é™©ï¼šç¯å¢ƒå‡çº§å¯èƒ½å¯¼è‡´è¡Œä¸ºå·®å¼‚

### 8.3 å®‰å…¨ä¸è¯¯æ“ä½œé£é™©
- äº¤æ˜“ç›¸å…³èƒ½åŠ›å­˜åœ¨ï¼Œä½†å®é™…é£æ§ç»†èŠ‚ï¼ˆç™½åå•/é™é¢/ä¸‹å•å‰æ ¡éªŒ/æµ‹è¯•ç½‘åˆ‡æ¢ï¼‰éœ€è¦è¿›ä¸€æ­¥æ ¸æŸ¥

### 8.4 ä»»åŠ¡/å¹¶å‘ä¸€è‡´æ€§
- `TaskExecutor` ä¸ºçº¿ç¨‹è½®è¯¢æ¨¡å‹ï¼ŒçŠ¶æ€æ›´æ–°ä¸é‡è¯•é€»è¾‘ä¾èµ– `EnhancedCloudTaskPublisher` çš„ä¸€è‡´æ€§å®ç°
- å›è°ƒç­¾åæ ¡éªŒã€å¹‚ç­‰ã€å¤±è´¥é‡æ”¾ç­‰éœ€è¦è¿›ä¸€æ­¥æ ¸å¯¹å®ç°æ–‡ä»¶

### 8.5 worker/Redis ä¾èµ–
- `qinglong_worker.py` ä¾èµ– Redis + `Heablcoin` å†…çš„é€šçŸ¥/äº¤æ˜“æ‰€èƒ½åŠ›ï¼Œéƒ¨ç½²ç¯å¢ƒå®¹æ˜“å‡ºç°è·¯å¾„/ä¾èµ–/å‡­è¯é—®é¢˜

---

> ğŸ“š [è¿”å›æ–‡æ¡£ç´¢å¼•](../docs/æ–‡æ¡£ç´¢å¼•.md)
