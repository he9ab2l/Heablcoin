# 模块与数据流分析（只读学习）

> 本文件为长期维护入口（无时间戳）。
>
> - 历史快照：`分析/模块与数据流_20251219_010624.md`
> - 快照 Git HEAD：`20e9affa75619fdcbb863d5c837a7dd3f80743e4`

## 1. MCP 工具与代码分层：谁负责什么

### 1.1 工具注册层（`src/tools/*`）
- 作用：将业务能力注册为 MCP tool
- 特点：
  - 通过 `core.mcp_safety.mcp_tool_safe` 统一做异常隔离/软禁用/避免 stdout 污染
  - 通常只是参数解析 + 调用 `skills/*`

### 1.2 业务能力层（`src/skills/*`）
- `skills/market_analysis/*`: 市场分析模块化系统
- `skills/personal_analytics/*`: 个人绩效分析模块化系统
- `skills/learning/*`: 学习训练与纪律系统（包括下单拦截 evaluate_order 等）
- `skills/report/*`: 报告与备份（含 `flexible_report` 邮件报告引擎）

### 1.3 运行时核心（`src/core/*`）
- `core/server.py`: MCP 服务器主进程 + 内置工具（交易、账户、AI建议、报告、监控）
- `core/mcp_safety.py`: 工具安全封装 + stdout 重定向兜底
- `core/tool_registry.py`: 软禁用/可观测工具注册表
- `core/exchange.py`: ccxt 交易所连接池（TTL 复用）
- `core/cloud/*`: 任务发布/队列/调度/API 管理
- `core/orchestration/*`: 多模型编排（Plan -> Steps -> Provider）

## 2. MCP stdout/稳定性保护链路（关键）

### 2.1 stdout 污染防护
- `core/server.py` 启动阶段将 `sys.stdout = sys.stderr`
- `mcp_tool_safe` 再做 `contextlib.redirect_stdout(sys.stderr)`

### 2.2 工具异常隔离
- `mcp_tool_safe` 捕获异常，返回用户可读错误；在 `DEBUG_MODE=true` 时附加 traceback

### 2.3 工具软禁用
- `core/tool_registry.py`:
  - 环境变量：`TOOLS_DISABLED` / `TOOLS_ENABLED_ONLY`
  - 运行时工具：`admin_tools.set_tool_enabled()` / `reset_tool_overrides()`

## 3. `core/server.py` 内置工具：功能与数据流

> 本节针对 `core/server.py` 中直接注册的 MCP tools（非 `src/tools/*` 那批）。

### 3.1 市场分析（内置版）
- `get_comprehensive_analysis(symbol,timeframe)`
  - 数据源：`ccxt.fetch_ohlcv` + `ccxt.fetch_ticker`
  - 指标：`calculate_indicators()` 计算 RSI/MACD/SMA/EMA/布林带/ATR/量比
  - 输出：Markdown 文本
- `get_market_sentiment(symbol)`
  - 逻辑：基于 ticker/技术指标做简单情绪打分（偏启发式）
- `get_multi_symbol_overview()`
  - 固定扫描：`BTC/ETH/BNB/SOL/XRP`，对每个币种取 `OHLCV_LIMIT_OVERVIEW` 并计算 RSI

### 3.2 AI 智能建议（注意：此处“AI”主要是规则引擎式组合，不是外部大模型）
- `get_ai_trading_advice(symbol,mode)`
  - 数据：`fetch_ohlcv('1h', limit=OHLCV_LIMIT_SIGNALS)` + `calculate_indicators`
  - 信号计票：RSI/均线趋势/MACD/布林带/量比（放量且涨->buy，放量且跌->sell）
  - 方向判定：buy/sell/hold（阈值 >40%）
  - 支撑阻力：过去 20 根高低点的平均（3 个极值均值）
  - 风险参数：ATR 推导 stop_loss / take_profit
  - 输出：
    - `simple`：面向新手，解释性文本
    - `professional`：更结构化 + 进场区间 + 风险回报比

- `get_market_overview(mode)`
  - 固定扫描：`BTC/ETH/BNB/SOL/XRP/ADA`
  - 为每币种算简单 buy/sell 信号
  - 输出：simple 为红绿灯概览；professional 需要继续精读后半段

- `get_trading_signals(symbol)`
  - 汇总多项信号，给出“买/卖/持有”计票条形图

- `get_position_recommendation(symbol, account_balance, risk_tolerance)`
  - 若未提供余额：`fetch_balance()['free']['USDT']`
  - 风险参数：conservative/moderate/aggressive 三档，基于 ATR 生成 stop_distance，反推仓位
  - 输出：给出建议仓位数量/价值/入场区间/止损/止盈/风险回报比

### 3.3 账户管理
- `get_account_summary()`
  - `fetch_balance()` 获取资产
  - 对非稳定币资产：优先 `fetch_tickers()` 批量拿价（失败则逐个 `fetch_ticker` 降级）
  - 输出：总估值、可用 USDT、今日已交易额度（来自交易记录）、持仓明细

- `get_open_orders(symbol=None)`
  - symbol 为空时：遍历 `_get_allowed_symbols()` 白名单逐个 `fetch_open_orders(sym)`
  - 目的：避免 ccxt “无 symbol 拉取挂单”告警/速率限制

- `cancel_order(order_id, symbol)`

### 3.4 交易执行与风控
- 白名单：`_get_allowed_symbols()` 从 env `ALLOWED_SYMBOLS` 解析，默认内置一批主流币
- 单笔限额：`_get_max_trade_amount()` -> env `MAX_TRADE_AMOUNT`，默认 1000 USDT
- 每日限额：`_get_daily_trade_limit()` -> env `DAILY_TRADE_LIMIT`，默认 5000 USDT

- `place_order(symbol, side, amount, price=None, order_type='market')`
  - 价格：`fetch_ticker(symbol)['last']` 作为市价参考
  - 成本：`amount * exec_price`
  - 风控：若 `cost > MAX_TRADE_AMOUNT` 直接拒绝
  - 纪律拦截（可选）：调用 `skills.learning.discipline.evaluate_order(symbol,side,estimated_cost)`，若不允许则直接返回原因
  - 下单：`exchange.create_order(...)`
  - 记录：`log_trade(...)`（CSV + 可选 SQLite）并触发 `send_trade_notification`

- `execute_strategy(symbol,strategy,amount)`
  - 白名单强校验：不在白名单直接拒绝
  - 策略：`RSI_Oversold / RSI_Overbought / MA_Crossover / BB_Breakout`
  - 触发后直接复用 `place_order` 下单

### 3.5 报告与通知
- `generate_analysis_report(symbol, mode, timeframe, include_sections, save_local, send_email_report, report_title)`
  - 章节组合：AI建议/技术分析/情绪/信号/仓位/市场全景
  - 支持落盘：`reports/analysis_reports/YYYYMMDD/<ts>__<symbol>__<mode>__<tf>.md` 与 `.meta.json`
  - 支持邮件：复用 `send_email(title, html, msg_type='REPORT')`

- 通知开关（运行时覆盖）：`get_notification_settings()` / `set_notification_settings()`

### 3.6 日志/监控与缓存
- `get_server_logs(lines)`：读取 `LOG_FILE`
- `get_system_status()`：输出 testnet/mainnet、连接状态、邮件启用、交易限额、通知开关、文件路径
- `get_cache_stats()` / `clear_cache(pattern)`：smart_cache
- `get_performance_stats()`：smart_logger 性能统计

## 4. 任务系统（Enhanced Publisher + Executor）

### 4.1 持久化格式
- 文件：默认 `data/enhanced_cloud_tasks.json`
- 数据结构：`EnhancedCloudTask`（含 `priority/depends_on/retry_count/max_retries/timeout/expires_at/callback_url/...`）

### 4.2 状态流转
- `pending -> running -> completed|failed|cancelled|expired`
- `get_ready_tasks()` 会过滤：
  - status == pending
  - not expired
  - 依赖任务均已 completed
  - 按 `priority desc + created_at asc` 排序

### 4.3 回调机制（Webhook）
- 当任务状态更新到 `completed/failed/cancelled/expired` 且存在 `callback_url`：
  - 通过 `requests.post(callback_url, json=payload, timeout=10)`
  - 记录 `callback_attempts` 与 `callback_last_error`

## 5. 当前缺陷/风险点（基于已读代码的“证据化”结论）

- **[High] 任务回调未见签名**：`enhanced_publisher._invoke_callback` 直接 POST JSON，无鉴权头。如果公网暴露 callback，存在伪造/重放风险
- **[Mid] 风控覆盖不完全**：`place_order` 对单笔限额校验存在，但“每日限额”仅用于展示与统计，未在下单处强制拦截
- **[Low] 交易数量/精度校验不明确**：`place_order` 直接使用 `amount` 下单，未见市场最小下单量/步进精度校验

## 6. 后续只读任务建议
- 继续精读：
  - `utils/validators.py`（是否有 symbol/amount/condition 校验）
  - `skills/learning/discipline.py`（evaluate_order 规则与持久化）
  - `core/cloud/api_manager.py`（端点可用性/负载/熔断统计）
- 输出：
  - `分析/工具清单索引.md`（把所有 MCP tool 形成可搜索目录）
  - `分析/差异分析.md`（后续基于 git diff/文件变更）
