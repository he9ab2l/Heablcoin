# æ¨¡å—ä¸æ•°æ®æµåˆ†æ

## 1. MCP å·¥å…·ä¸ä»£ç åˆ†å±‚ï¼šè°è´Ÿè´£ä»€ä¹ˆ

### 1.1 å·¥å…·æ³¨å†Œå±‚ï¼ˆ`src/tools/*`ï¼‰
- ä½œç”¨ï¼šå°†ä¸šåŠ¡èƒ½åŠ›æ³¨å†Œä¸º MCP tool
- ç‰¹ç‚¹ï¼š
  - é€šè¿‡ `core.mcp_safety.mcp_tool_safe` ç»Ÿä¸€åšå¼‚å¸¸éš”ç¦»/è½¯ç¦ç”¨/é¿å… stdout æ±¡æŸ“
  - é€šå¸¸åªæ˜¯å‚æ•°è§£æ + è°ƒç”¨ `skills/*`

### 1.2 ä¸šåŠ¡èƒ½åŠ›å±‚ï¼ˆ`src/skills/*`ï¼‰
- `skills/market_analysis/*`: å¸‚åœºåˆ†ææ¨¡å—åŒ–ç³»ç»Ÿ
- `skills/personal_analytics/*`: ä¸ªäººç»©æ•ˆåˆ†ææ¨¡å—åŒ–ç³»ç»Ÿ
- `skills/learning/*`: å­¦ä¹ è®­ç»ƒä¸çºªå¾‹ç³»ç»Ÿï¼ˆåŒ…æ‹¬ä¸‹å•æ‹¦æˆª evaluate_order ç­‰ï¼‰
- `skills/report/*`: æŠ¥å‘Šä¸å¤‡ä»½ï¼ˆå« `flexible_report` é‚®ä»¶æŠ¥å‘Šå¼•æ“ï¼‰

### 1.3 è¿è¡Œæ—¶æ ¸å¿ƒï¼ˆ`src/core/*`ï¼‰
- `core/server.py`: MCP æœåŠ¡å™¨ä¸»è¿›ç¨‹ + å†…ç½®å·¥å…·ï¼ˆäº¤æ˜“ã€è´¦æˆ·ã€AIå»ºè®®ã€æŠ¥å‘Šã€ç›‘æ§ï¼‰
- `core/mcp_safety.py`: å·¥å…·å®‰å…¨å°è£… + stdout é‡å®šå‘å…œåº•
- `core/tool_registry.py`: è½¯ç¦ç”¨/å¯è§‚æµ‹å·¥å…·æ³¨å†Œè¡¨
- `core/exchange.py`: ccxt äº¤æ˜“æ‰€è¿æ¥æ± ï¼ˆTTL å¤ç”¨ï¼‰
- `core/cloud/*`: ä»»åŠ¡å‘å¸ƒ/é˜Ÿåˆ—/è°ƒåº¦/API ç®¡ç†
- `core/orchestration/*`: å¤šæ¨¡å‹ç¼–æ’ï¼ˆPlan -> Steps -> Providerï¼‰

## 2. MCP stdout/ç¨³å®šæ€§ä¿æŠ¤é“¾è·¯ï¼ˆå…³é”®ï¼‰

### 2.1 stdout æ±¡æŸ“é˜²æŠ¤
- `core/server.py` å¯åŠ¨é˜¶æ®µå°† `sys.stdout = sys.stderr`
- `mcp_tool_safe` å†åš `contextlib.redirect_stdout(sys.stderr)`

### 2.2 å·¥å…·å¼‚å¸¸éš”ç¦»
- `mcp_tool_safe` æ•è·å¼‚å¸¸ï¼Œè¿”å›ç”¨æˆ·å¯è¯»é”™è¯¯ï¼›åœ¨ `DEBUG_MODE=true` æ—¶é™„åŠ  traceback

### 2.3 å·¥å…·è½¯ç¦ç”¨
- `core/tool_registry.py`:
  - ç¯å¢ƒå˜é‡ï¼š`TOOLS_DISABLED` / `TOOLS_ENABLED_ONLY`
  - è¿è¡Œæ—¶å·¥å…·ï¼š`admin_tools.set_tool_enabled()` / `reset_tool_overrides()`

## 3. `core/server.py` å†…ç½®å·¥å…·ï¼šåŠŸèƒ½ä¸æ•°æ®æµ

> æœ¬èŠ‚é’ˆå¯¹ `core/server.py` ä¸­ç›´æ¥æ³¨å†Œçš„ MCP toolsï¼ˆé `src/tools/*` é‚£æ‰¹ï¼‰ã€‚

### 3.1 å¸‚åœºåˆ†æï¼ˆå†…ç½®ç‰ˆï¼‰
- `get_comprehensive_analysis(symbol,timeframe)`
  - æ•°æ®æºï¼š`ccxt.fetch_ohlcv` + `ccxt.fetch_ticker`
  - æŒ‡æ ‡ï¼š`calculate_indicators()` è®¡ç®— RSI/MACD/SMA/EMA/å¸ƒæ—å¸¦/ATR/é‡æ¯”
  - è¾“å‡ºï¼šMarkdown æ–‡æœ¬
- `get_market_sentiment(symbol)`
  - é€»è¾‘ï¼šåŸºäº ticker/æŠ€æœ¯æŒ‡æ ‡åšç®€å•æƒ…ç»ªæ‰“åˆ†ï¼ˆåå¯å‘å¼ï¼‰
- `get_multi_symbol_overview()`
  - å›ºå®šæ‰«æï¼š`BTC/ETH/BNB/SOL/XRP`ï¼Œå¯¹æ¯ä¸ªå¸ç§å– `OHLCV_LIMIT_OVERVIEW` å¹¶è®¡ç®— RSI

### 3.2 AI æ™ºèƒ½å»ºè®®ï¼ˆæ³¨æ„ï¼šæ­¤å¤„â€œAIâ€ä¸»è¦æ˜¯è§„åˆ™å¼•æ“å¼ç»„åˆï¼Œä¸æ˜¯å¤–éƒ¨å¤§æ¨¡å‹ï¼‰
- `get_ai_trading_advice(symbol,mode)`
  - æ•°æ®ï¼š`fetch_ohlcv('1h', limit=OHLCV_LIMIT_SIGNALS)` + `calculate_indicators`
  - ä¿¡å·è®¡ç¥¨ï¼šRSI/å‡çº¿è¶‹åŠ¿/MACD/å¸ƒæ—å¸¦/é‡æ¯”ï¼ˆæ”¾é‡ä¸”æ¶¨->buyï¼Œæ”¾é‡ä¸”è·Œ->sellï¼‰
  - æ–¹å‘åˆ¤å®šï¼šbuy/sell/holdï¼ˆé˜ˆå€¼ >40%ï¼‰
  - æ”¯æ’‘é˜»åŠ›ï¼šè¿‡å» 20 æ ¹é«˜ä½ç‚¹çš„å¹³å‡ï¼ˆ3 ä¸ªæå€¼å‡å€¼ï¼‰
  - é£é™©å‚æ•°ï¼šATR æ¨å¯¼ stop_loss / take_profit
  - è¾“å‡ºï¼š
    - `simple`ï¼šé¢å‘æ–°æ‰‹ï¼Œè§£é‡Šæ€§æ–‡æœ¬
    - `professional`ï¼šæ›´ç»“æ„åŒ– + è¿›åœºåŒºé—´ + é£é™©å›æŠ¥æ¯”

- `get_market_overview(mode)`
  - å›ºå®šæ‰«æï¼š`BTC/ETH/BNB/SOL/XRP/ADA`
  - ä¸ºæ¯å¸ç§ç®—ç®€å• buy/sell ä¿¡å·
  - è¾“å‡ºï¼šsimple ä¸ºçº¢ç»¿ç¯æ¦‚è§ˆï¼›professional éœ€è¦ç»§ç»­ç²¾è¯»ååŠæ®µ

- `get_trading_signals(symbol)`
  - æ±‡æ€»å¤šé¡¹ä¿¡å·ï¼Œç»™å‡ºâ€œä¹°/å–/æŒæœ‰â€è®¡ç¥¨æ¡å½¢å›¾

- `get_position_recommendation(symbol, account_balance, risk_tolerance)`
  - è‹¥æœªæä¾›ä½™é¢ï¼š`fetch_balance()['free']['USDT']`
  - é£é™©å‚æ•°ï¼šconservative/moderate/aggressive ä¸‰æ¡£ï¼ŒåŸºäº ATR ç”Ÿæˆ stop_distanceï¼Œåæ¨ä»“ä½
  - è¾“å‡ºï¼šç»™å‡ºå»ºè®®ä»“ä½æ•°é‡/ä»·å€¼/å…¥åœºåŒºé—´/æ­¢æŸ/æ­¢ç›ˆ/é£é™©å›æŠ¥æ¯”

### 3.3 è´¦æˆ·ç®¡ç†
- `get_account_summary()`
  - `fetch_balance()` è·å–èµ„äº§
  - å¯¹éç¨³å®šå¸èµ„äº§ï¼šä¼˜å…ˆ `fetch_tickers()` æ‰¹é‡æ‹¿ä»·ï¼ˆå¤±è´¥åˆ™é€ä¸ª `fetch_ticker` é™çº§ï¼‰
  - è¾“å‡ºï¼šæ€»ä¼°å€¼ã€å¯ç”¨ USDTã€ä»Šæ—¥å·²äº¤æ˜“é¢åº¦ï¼ˆæ¥è‡ªäº¤æ˜“è®°å½•ï¼‰ã€æŒä»“æ˜ç»†

- `get_open_orders(symbol=None)`
  - symbol ä¸ºç©ºæ—¶ï¼šéå† `_get_allowed_symbols()` ç™½åå•é€ä¸ª `fetch_open_orders(sym)`
  - ç›®çš„ï¼šé¿å… ccxt â€œæ—  symbol æ‹‰å–æŒ‚å•â€å‘Šè­¦/é€Ÿç‡é™åˆ¶

- `cancel_order(order_id, symbol)`

### 3.4 äº¤æ˜“æ‰§è¡Œä¸é£æ§
- ç™½åå•ï¼š`_get_allowed_symbols()` ä» env `ALLOWED_SYMBOLS` è§£æï¼Œé»˜è®¤å†…ç½®ä¸€æ‰¹ä¸»æµå¸
- å•ç¬”é™é¢ï¼š`_get_max_trade_amount()` -> env `MAX_TRADE_AMOUNT`ï¼Œé»˜è®¤ 1000 USDT
- æ¯æ—¥é™é¢ï¼š`_get_daily_trade_limit()` -> env `DAILY_TRADE_LIMIT`ï¼Œé»˜è®¤ 5000 USDT

- `place_order(symbol, side, amount, price=None, order_type='market')`
  - ä»·æ ¼ï¼š`fetch_ticker(symbol)['last']` ä½œä¸ºå¸‚ä»·å‚è€ƒ
  - æˆæœ¬ï¼š`amount * exec_price`
  - é£æ§ï¼šè‹¥ `cost > MAX_TRADE_AMOUNT` ç›´æ¥æ‹’ç»
  - çºªå¾‹æ‹¦æˆªï¼ˆå¯é€‰ï¼‰ï¼šè°ƒç”¨ `skills.learning.discipline.evaluate_order(symbol,side,estimated_cost)`ï¼Œè‹¥ä¸å…è®¸åˆ™ç›´æ¥è¿”å›åŸå› 
  - ä¸‹å•ï¼š`exchange.create_order(...)`
  - è®°å½•ï¼š`log_trade(...)`ï¼ˆCSV + å¯é€‰ SQLiteï¼‰å¹¶è§¦å‘ `send_trade_notification`

- `execute_strategy(symbol,strategy,amount)`
  - ç™½åå•å¼ºæ ¡éªŒï¼šä¸åœ¨ç™½åå•ç›´æ¥æ‹’ç»
  - ç­–ç•¥ï¼š`RSI_Oversold / RSI_Overbought / MA_Crossover / BB_Breakout`
  - è§¦å‘åç›´æ¥å¤ç”¨ `place_order` ä¸‹å•

### 3.5 æŠ¥å‘Šä¸é€šçŸ¥
- `generate_analysis_report(symbol, mode, timeframe, include_sections, save_local, send_email_report, report_title)`
  - ç« èŠ‚ç»„åˆï¼šAIå»ºè®®/æŠ€æœ¯åˆ†æ/æƒ…ç»ª/ä¿¡å·/ä»“ä½/å¸‚åœºå…¨æ™¯
  - æ”¯æŒè½ç›˜ï¼š`reports/analysis_reports/YYYYMMDD/<ts>__<symbol>__<mode>__<tf>.md` ä¸ `.meta.json`
  - æ”¯æŒé‚®ä»¶ï¼šå¤ç”¨ `send_email(title, html, msg_type='REPORT')`

- é€šçŸ¥å¼€å…³ï¼ˆè¿è¡Œæ—¶è¦†ç›–ï¼‰ï¼š`get_notification_settings()` / `set_notification_settings()`

### 3.6 æ—¥å¿—/ç›‘æ§ä¸ç¼“å­˜
- `get_server_logs(lines)`ï¼šè¯»å– `LOG_FILE`
- `get_system_status()`ï¼šè¾“å‡º testnet/mainnetã€è¿æ¥çŠ¶æ€ã€é‚®ä»¶å¯ç”¨ã€äº¤æ˜“é™é¢ã€é€šçŸ¥å¼€å…³ã€æ–‡ä»¶è·¯å¾„
- `get_cache_stats()` / `clear_cache(pattern)`ï¼šsmart_cache
- `get_performance_stats()`ï¼šsmart_logger æ€§èƒ½ç»Ÿè®¡

## 4. ä»»åŠ¡ç³»ç»Ÿï¼ˆEnhanced Publisher + Executorï¼‰

### 4.1 æŒä¹…åŒ–æ ¼å¼
- æ–‡ä»¶ï¼šé»˜è®¤ `data/enhanced_cloud_tasks.json`
- æ•°æ®ç»“æ„ï¼š`EnhancedCloudTask`ï¼ˆå« `priority/depends_on/retry_count/max_retries/timeout/expires_at/callback_url/...`ï¼‰

### 4.2 çŠ¶æ€æµè½¬
- `pending -> running -> completed|failed|cancelled|expired`
- `get_ready_tasks()` ä¼šè¿‡æ»¤ï¼š
  - status == pending
  - not expired
  - ä¾èµ–ä»»åŠ¡å‡å·² completed
  - æŒ‰ `priority desc + created_at asc` æ’åº

### 4.3 å›è°ƒæœºåˆ¶ï¼ˆWebhookï¼‰
- å½“ä»»åŠ¡çŠ¶æ€æ›´æ–°åˆ° `completed/failed/cancelled/expired` ä¸”å­˜åœ¨ `callback_url`ï¼š
  - é€šè¿‡ `requests.post(callback_url, json=payload, timeout=10)`
  - è®°å½• `callback_attempts` ä¸ `callback_last_error`

## 5. å½“å‰ç¼ºé™·/é£é™©ç‚¹ï¼ˆåŸºäºå·²è¯»ä»£ç çš„â€œè¯æ®åŒ–â€ç»“è®ºï¼‰

- **[High] ä»»åŠ¡å›è°ƒæœªè§ç­¾å**ï¼š`enhanced_publisher._invoke_callback` ç›´æ¥ POST JSONï¼Œæ— é‰´æƒå¤´ã€‚å¦‚æœå…¬ç½‘æš´éœ² callbackï¼Œå­˜åœ¨ä¼ªé€ /é‡æ”¾é£é™©
- **[Mid] é£æ§è¦†ç›–ä¸å®Œå…¨**ï¼š`place_order` å¯¹å•ç¬”é™é¢æ ¡éªŒå­˜åœ¨ï¼Œä½†â€œæ¯æ—¥é™é¢â€ä»…ç”¨äºå±•ç¤ºä¸ç»Ÿè®¡ï¼Œæœªåœ¨ä¸‹å•å¤„å¼ºåˆ¶æ‹¦æˆª
- **[Low] äº¤æ˜“æ•°é‡/ç²¾åº¦æ ¡éªŒä¸æ˜ç¡®**ï¼š`place_order` ç›´æ¥ä½¿ç”¨ `amount` ä¸‹å•ï¼Œæœªè§å¸‚åœºæœ€å°ä¸‹å•é‡/æ­¥è¿›ç²¾åº¦æ ¡éªŒ

---

> ğŸ“š [è¿”å›æ–‡æ¡£ç´¢å¼•](../docs/æ–‡æ¡£ç´¢å¼•.md)
