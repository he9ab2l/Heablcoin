# 优缺点与风险清单（只读学习，证据化）

- 时间（北京时间）: `20251219_010927`
- Git HEAD: `20e9affa75619fdcbb863d5c837a7dd3f80743e4`

## 1. 优点（已确认）

### 1.1 MCP 协议保护意识强（High）
- **证据**:
  - `src/core/server.py` 将 `sys.stdout` 重定向到 `sys.stderr`，避免 JSON-RPC 通道被污染
  - `src/core/mcp_safety.py:mcp_tool_safe` 进一步 `redirect_stdout(sys.stderr)` 并捕获所有异常
- **收益**:
  - 明显降低 MCP client 侧的 `Invalid JSON` / `Connection failed` 类问题

### 1.2 分层合理，可扩展（High）
- **证据**:
  - `src/tools/*`：工具注册层
  - `src/skills/*`：业务能力层
  - `src/core/*`：运行时/安全/编排/云端
  - `src/storage/*`：适配器
  - `src/utils/*`：通用组件
- **收益**:
  - 新增工具通常只需在 `tools` 注册，业务逻辑放 `skills`

### 1.3 Tool 软禁用能力（Mid）
- **证据**:
  - `src/core/tool_registry.py` 支持 `TOOLS_DISABLED` / `TOOLS_ENABLED_ONLY` 与运行时覆盖
  - `src/tools/admin_tools.py` 暴露 `set_tool_enabled` 等管理工具
- **收益**:
  - 在生产环境可快速禁用高风险工具（例如 `place_order`）而不需要热更新卸载

### 1.4 任务系统能力较完整（Mid）
- **证据**:
  - `src/core/cloud/enhanced_publisher.py` 支持：优先级、依赖、过期、重试、回调记录
  - `src/core/cloud/task_executor.py` 负责轮询并执行 handler
- **收益**:
  - 可实现异步分析/异步报告/异步调用外部 AI

### 1.5 输入校验组件（Low~Mid）
- **证据**:
  - `src/utils/validators.py` 提供 `parse_price` / `validate_price_condition` / `normalize_symbol` 等
  - 对应测试：`tests/test_validators.py`
- **收益**:
  - 对任务参数（如价格条件）提供最小安全边界

## 2. 缺陷与风险（按等级）

### 2.1 [High] 任务回调（Webhook）缺少签名/鉴权
- **证据**:
  - `src/core/cloud/enhanced_publisher.py:_invoke_callback` 直接 `requests.post(callback_url, json=payload, timeout=10)`
  - 未见 `TASK_WEBHOOK_SECRET` 相关 HMAC 或 header（如 `X-Heabl-Signature`）
- **影响**:
  - callback 接收端难以确认请求来自 Heablcoin
  - 若 callback_url 暴露在公网，存在伪造/欺骗状态通知风险
- **改进建议（仅建议，不改代码）**:
  - 增加签名：HMAC-SHA256(secret, body)
  - 发送 `X-Heabl-Signature` + `X-Heabl-Timestamp`
  - 接收端校验时间窗与签名

### 2.2 [Mid] 每日限额未在下单链路强制执行
- **证据**:
  - `src/core/server.py:place_order` 仅检查 `_get_max_trade_amount()`（单笔限额）
  - `DAILY_TRADE_LIMIT` 仅在 `get_account_summary` 展示与 `get_daily_traded_amount` 统计展示
- **影响**:
  - 用户可能在多次小额下单时超出每日总限额
- **改进建议**:
  - 下单前额外校验：`get_daily_traded_amount() + cost <= _get_daily_trade_limit()`

### 2.3 [Mid] 交易数量/交易精度校验不足（可能导致下单失败）
- **证据**:
  - `src/core/server.py:place_order` 直接使用 `amount` 调 `ccxt.create_order`
  - 未见对最小下单量、步进精度、最小名义价值等限制的显式校验
- **影响**:
  - 运行时才被交易所拒绝，用户体验差；也可能触发频繁失败
- **改进建议**:
  - 下单前用 `exchange.load_markets()` 获取 `limits/precision` 做本地校验和 round

### 2.4 [Mid] `validate_price_condition` 允许负数阈值
- **证据**:
  - `src/utils/validators.py:validate_price_condition` 正则允许 `-?\d+`，返回 float，可为负数
- **影响**:
  - 对 `price < -1` 这类条件不具备业务意义，可能造成误配置
- **改进建议**:
  - 增加 `min_value` 或明确要求阈值 > 0

### 2.5 [Low] `normalize_symbol` 只做大小写/分隔符标准化
- **证据**:
  - `src/utils/validators.py:normalize_symbol` 仅 `replace` + `upper`
- **影响**:
  - 仍可能输入不存在的交易对
- **改进建议**:
  - 增加基于 `exchange.markets` 的存在性校验（可选开关）

### 2.6 [Low] `ApiManager` 存在“方法重复定义/覆盖”风险
- **证据**:
  - `src/core/cloud/api_manager.py` 中 `get_available_endpoints` 被定义了两次：
    - 第一次：支持 exclude + 状态/速率过滤 + 综合排序
    - 第二次：无参数版本，会覆盖前者（Python 后定义覆盖前定义）
- **影响**:
  - 代码意图与实际运行可能不一致，可能影响端点选择策略
- **改进建议**:
  - 重命名其中一个方法或合并逻辑

## 3. 学习纪律拦截机制（现状总结）

- **证据**:
  - `src/skills/learning/discipline.py:evaluate_order`
  - 规则文件：`reports/execution_guard/rules.json`
  - 状态文件：`reports/execution_guard/state.json`
- **机制**:
  - 默认 `enabled=false`（不开启不拦截）
  - 开启后：
    - 冷静期锁定：`locked_until`
    - 可选趋势拦截：调用 `skills.market_analysis` 的 `technical` 输出，若买入但趋势“看跌”则拒绝并进入冷静期（卖出对“看涨”同理）

## 4. 结论

- 项目在 MCP 协议保护、模块分层、工具治理方面表现较好
- 当前主要安全风险集中在：任务回调鉴权、下单风控覆盖（每日限额/精度）以及 ApiManager 的方法覆盖问题

