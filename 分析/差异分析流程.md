# 差异分析流程（规范版，用于回归与审计）

> 本文件为长期维护入口（无时间戳）。
>
> - 历史快照：
>   - `分析/差异分析流程_20251219_010927.md`（规范版流程）

## 1. 基线记录（每次分析必写）
- `git rev-parse HEAD`
- `git log -1 --oneline`
- `git status -sb`（确认是否有未提交改动）
- 输出新增文件目录：`dir 分析`（PowerShell）

## 2. 差异获取（建议顺序）
1) **统计量级**：`git diff --stat <old>..<new>`
2) **文件级清单**：`git diff --name-status <old>..<new>`
3) **重点目录优先看**：
   - `src/core/`（server/任务/安全/路径）
   - `src/tools/`（MCP 工具改动）
   - `src/skills/`（业务策略/风控/分析）
   - `src/storage/`（适配层/外部集成）
   - `docs/`（使用方式与配置变更）
   - `tests/`（回归范围变动）

## 3. 变更类型模版
- **接口变更**：新增/删除/重命名 tool，参数或返回结构变化。
- **数据流变更**：数据源、落盘路径、队列格式、状态机调整。
- **安全变更**：鉴权、签名、密钥处理、风控策略。
- **性能变更**：缓存、并发、批量模型。
- **可观察性变更**：日志字段、错误码、统计项。

## 4. 报告结构（固定格式）
1. 基线信息
2. 变更摘要（按目录分组）
3. MCP 工具变化（新增/删除/参数调整）
4. 安全复核（是否触及白名单、限额、熔断、密钥）
5. 回归测试建议（需要跑的 tests）
6. 未解事项与下一步

## 5. 高频检查项（建议每次确认）
- `core/server.py`：白名单/单次/每日限额，stdout 隔离，报错输出。
- `core/cloud/*`：任务状态机与回调的健壮性。
- `utils/validators.py`：边界校验是否遗漏。
- `tools/*`：是否有新增/改名工具未在文档/测试覆盖。

## 6. 产物清单（必须落盘）
- `分析/差异分析_*.md`（按本流程输出）
- 如变更触及架构/数据流：同步更新 `可视化系统架构.mmd`（手工维护）

## 7. 环境与编码
- 所有文档保持 UTF-8，无 BOM，无问号占位。
- Windows 侧写文件使用脚本或编辑器保存 UTF-8，避免控制台直接输入中文导致退化。
- 提交前执行：
  - `python scripts/check_naming.py`
  - `python tests/run_tests.py unit`

---

## 附录 A：案例复盘（历史记录编码修复）

> 目的：给“流程”提供一个实际案例样板，便于以后回归/审计时复用。

### A.1 现象
- `python tests/run_tests.py unit` 在“项目记录文件回归测试”阶段报 “含 ASCII '?'”。
- `历史记录.json` 中多条记录被 `?` 污染，新治理条目缺失。

### A.2 根因
- 早期在 Windows 控制台直接输入中文，编码回退成 `?`；合入治理功能时未同步旧记录，导致 JSON 与日志脱节。
- `任务.txt` 虽提示“禁止乱码”，但缺少自动校验，直到测试命中。

### A.3 处理动作
1. 用 Python 生成器重写 `历史记录.json`：保留 12-18 里程碑，补记 12-19 任务发布/量化研究/治理升级。
2. 采用 ASCII 安全输出（必要时可 `ensure_ascii=True`），避免跨终端再次劣化；中文路径统一用 `\\uXXXX` 写入。
3. 修复 `_按时间轴_`、`审计专家系统`、`API参考`、`任务.txt` 等字段的转义残留，清除所有 `?`。
4. 重跑 `python tests/run_tests.py unit`、`python scripts/check_naming.py`，验证记录文件与命名规范。
5. 将本复盘材料并入本文档附录。

### A.4 验证
- `python tests/run_tests.py unit` ✅ 通过。
- `python scripts/check_naming.py` ✅ 通过。
- `Select-String -Pattern '\\?' 历史记录.json` ✅ 无命中。

### A.5 后续建议
- 在 CI 中追加“记录文件 UTF-8 检查”和 `scripts/scan_secrets.py`，放在命名检查之后执行。
- 新增功能前先更新 `历史记录.json` / `任务进度.json`，再改代码，保证记录与实现同步。
- Windows 侧一律用脚本写中文内容，禁止在控制台直接输入。
