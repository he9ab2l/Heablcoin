# 差异分析流程（规范版，用于回归与审计）

- 时间（北京时间）：`2025-12-19 01:09:27`
- 目标：在项目频繁演进时，固定一套“变更要点 + 影响回溯 + 安全复核”流程，确保每轮改动都可定位、可验证、可审计。

## 1. 基线记录（每次分析必写）
- `git rev-parse HEAD`
- `git log -1 --oneline`
- `git status -sb`（确认是否有未提交改动）
- 输出新增文件目录：`ls 分析/`

## 2. 差异获取（建议顺序）
1) **统计量级**：`git diff --stat <old>..<new>`
2) **文件级清单**：`git diff --name-status <old>..<new>`
3) **重点目录优先看**：
   - `src/core/`（server/任务/安全/路径）
   - `src/tools/`（MCP 工具改动）
   - `src/skills/`（业务策略/风控/分析）
   - `src/storage/`（适配层/外部集成）
   - `docs/`（使用方式与配置变更）
   - `tests/`（回归范围变动）

## 3. 变更类型模版
- **接口变更**：新增/删除/重命名 tool，参数或返回结构变化。
- **数据流变更**：数据源、落盘路径、队列格式、状态机调整。
- **安全变更**：鉴权、签名、密钥处理、风控策略。
- **性能变更**：缓存、并发、批量模型。
- **可观察性变更**：日志字段、错误码、统计项。

## 4. 报告结构（固定格式）
1. 基线信息
2. 变更摘要（按目录分组）
3. MCP 工具变化（新增/删除/参数调整）
4. 安全复核（是否触及白名单、限额、熔断、密钥）
5. 回归测试建议（需要跑的 tests）
6. 未解事项与下一步

## 5. 高频检查项（建议每次确认）
- `core/server.py`：白名单/单次/每日限额，stdout 隔离，报错输出。
- `core/cloud/*`：任务状态机与回调的健壮性。
- `utils/validators.py`：边界校验是否遗漏。
- `tools/*`：是否有新增/改名工具未在文档/测试覆盖。

## 6. 产物清单（必须落盘）
- `分析/差异分析_*.md`（本文件即模版）
- 如变更触及架构/数据流：同步更新 `可视化系统架构.mmd`（手工维护）

## 7. 环境与编码
- 所有文档保持 UTF-8，无 BOM，无问号占位。
- Windows 侧写文件使用脚本或编辑器保存 UTF-8，避免控制台直接输入中文导致退化。
- 提交前执行：`python scripts/check_naming.py`、`python tests/run_tests.py unit`。
