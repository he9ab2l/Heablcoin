# 使用方式与配置汇总

## 1. 最小可运行（最短路径）

### 1.1 环境
- Python `3.10+`
- 建议创建虚拟环境（Windows: `python -m venv venv` + `venv\Scripts\activate`）

### 1.2 安装依赖
- 命令：`pip install -r requirements.txt`

### 1.3 配置 `.env`
- 从模板复制：`copy .env.example .env`（Windows）
- 详细配置说明：`env配置说明.md`

**必填（核心）**
- `BINANCE_API_KEY`
- `BINANCE_SECRET_KEY`
- `USE_TESTNET=True`（强烈建议先用测试网）

**可选（但常用）**
- 邮件：`EMAIL_NOTIFICATIONS_ENABLED=True` + `SENDER_EMAIL/SENDER_PASSWORD/RECIPIENT_EMAIL/SMTP_SERVER/SMTP_PORT`
- AI：可填任意一个 provider key；不填会回退离线 `echo`（仍可运行，但 AI 路由类能力会降级）

### 1.4 本地自检
- 快速自检脚本：`python Heablcoin-test.py --quick`
- 回归测试（示例）：
  - `python tests/run_tests.py unit`
  - `python tests/run_tests.py integration`

## 2. MCP 客户端接入（Claude Desktop / Windsurf / Codex CLI）

### 2.1 Claude Desktop
- 配置路径（Windows）：`%APPDATA%\Claude\claude_desktop_config.json`
- 核心配置要点：
  - `args` 使用**绝对路径**指向 `Heablcoin.py`
  - Windows 建议设置 UTF-8：`PYTHONIOENCODING=utf-8`、`PYTHONUTF8=1`

示例（Windows）：
```json
{
  "mcpServers": {
    "heablcoin": {
      "command": "python",
      "args": ["d:\\MCP\\Heablcoin.py"],
      "env": {
        "PYTHONIOENCODING": "utf-8",
        "PYTHONUTF8": "1"
      }
    }
  }
}
```

### 2.2 Windsurf
- 配置路径（Windows）：`%APPDATA%\Windsurf\mcp_config.json`
- 推荐使用正斜杠：`d:/MCP/Heablcoin.py`

### 2.3 Codex CLI
- `codex mcp add heablcoin --env PYTHONIOENCODING=utf-8 --env PYTHONUTF8=1 -- python d:/MCP/Heablcoin.py`

## 3. `.env` 变量分类速查（摘要）

> 说明：完整变量清单请以 `env配置说明.md` 为准；此处仅保留分类速查。

### 3.1 交易所 / CCXT
- `BINANCE_API_KEY` / `BINANCE_SECRET_KEY`
- `USE_TESTNET`
- `EXCHANGE_POOL_TTL_SECONDS`
- `CCXT_TIMEOUT_MS` / `CCXT_ENABLE_RATE_LIMIT` / `CCXT_DEFAULT_TYPE` / `CCXT_RECV_WINDOW` / `CCXT_ADJUST_TIME_DIFFERENCE`

### 3.2 风控与行情上限
- `ALLOWED_SYMBOLS`
- `MAX_TRADE_AMOUNT`
- `DAILY_TRADE_LIMIT`
- `OHLCV_LIMIT_*`（按模块分开控制）

### 3.3 AI 多模型
- 任意 provider key（`OPENAI_API_KEY`/`DEEPSEEK_API_KEY`/`ANTHROPIC_API_KEY`/`GEMINI_API_KEY`/`GROQ_API_KEY`/`MOONSHOT_API_KEY`/`ZHIPU_API_KEY`/`HEABL_*`）
- 路由：`AI_DEFAULT_PROVIDER`、`AI_ROUTE_ANALYSIS/CRITIQUE/SYNTHESIS/SAFETY`
- 超时：`AI_TIMEOUT`

### 3.4 邮件通知
- 总开关：`EMAIL_NOTIFICATIONS_ENABLED`
- 凭证：`SENDER_EMAIL`/`SENDER_PASSWORD`（或 `SMTP_USER`/`SMTP_PASS`）
- 收件：`RECIPIENT_EMAIL`（兼容 `RECEIVER_EMAIL`/`NOTIFY_EMAIL`）
- SMTP：`SMTP_SERVER`/`SMTP_PORT`
- 细分通知：`NOTIFY_TRADE_EXECUTION`/`NOTIFY_PRICE_ALERTS`/`NOTIFY_DAILY_REPORT`/`NOTIFY_SYSTEM_ERRORS`

### 3.5 日志/性能
- `LOG_LEVEL` / `LOG_FILE` / `LOG_DIR`
- `ENABLE_SMART_LOGGER` / `ENABLE_SMART_CACHE`
- `PERF_*` / `CACHE_DEFAULT_TTL_SECONDS`
- `DEBUG_MODE`

### 3.6 工具软禁用
- `TOOLS_DISABLED`
- `TOOLS_ENABLED_ONLY`

### 3.7 Redis / 云端
- `REDIS_URL` 或 `REDIS_HOST/REDIS_PORT/REDIS_PASSWORD`
- 青龙 worker：`RUN_ONCE`（默认 true）、`WORKER_INTERVAL`

## 4. 常见故障排查（摘要）

### 4.1 交易所连接失败
- 核查 `.env`：key/secret、`USE_TESTNET`
- 验证：`python Heablcoin-test.py --quick`

### 4.2 邮件发送失败（认证）
- 常见原因：SMTP 535（需授权码/应用专用密码）
- 验证：`python tests/run_tests.py email`
- 注意双开关：`EMAIL_NOTIFICATIONS_ENABLED` + `NOTIFY_*`

### 4.3 Claude/Windsurf 看不到工具
- 绝对路径是否正确
- Python 依赖是否安装
- 编码环境变量是否设置
- stdout 污染（项目已做 stderr 重定向，但第三方输出仍可能导致 JSONRPC 异常）

### 4.4 报告只生成部分章节
- 单独调用对应 tool 定位：`get_comprehensive_analysis/get_market_sentiment/get_ai_trading_advice`
- 查看 `logs/server_debug.log`

## 5. 你可以如何使用（建议工作流）

- **开发/验证**：先跑 `python tests/run_tests.py unit`
- **对话式使用**：Claude Desktop / Windsurf 配 MCP 后用自然语言触发工具
- **自动化脚本**：直接 `from Heablcoin import ...` 调用函数
