# 建议文档（命名规范 / 统一性 / 潜在问题 / 文档建议）

> 本文件为长期维护入口（无时间戳）。
>
> - 历史快照：`分析/建议文档_20251219_012951.md`
> - 快照 Git HEAD：`1f3e998716d0fcb69832af3db3a8780088ce2eff`
> - 原则：只提出建议，不修改任何现有源码

---

## 1. 命名规范与一致性（建议）

### 1.1 MCP Tool 命名统一
- **现状**：工具多为 `snake_case`，整体较统一；但存在不同模块对同类概念的参数名不完全一致（如 `symbols`/`symbol_list` 等未来可能出现）
- **建议**：
  - 统一参数命名：
    - 单一交易对统一用 `symbol`
    - 多交易对统一用 `symbols`（逗号分隔字符串）
    - 周期统一用 `timeframe`
    - 输出格式统一用 `return_format`（`markdown|json`）

### 1.2 “模式/类型/枚举”参数建议显式列举
- **现状**：部分工具 docstring 已列出可选值（如 `risk_tolerance`、`strategy`）
- **建议**：对每个工具在 docstring 中固定一段：
  - `Allowed values:` + 示例
  - 并在 `docs/developer/API参考.md` 同步

### 1.3 中英文混用的边界
- **现状**：面向用户输出为中文为主；内部模块/变量英文为主
- **建议**：
  - 内部类/函数保持英文（Python 社区习惯）
  - 用户输出 Markdown/JSON 的字段与描述保持中文
  - 对外 JSON 结构建议保持稳定字段（避免前端/脚本解析频繁破坏）

---

## 2. 可维护性与潜在 Bug 风险（证据化）

### 2.1 `ApiManager` 方法重复定义覆盖风险（Low -> Mid）
- **证据**：`src/core/cloud/api_manager.py` 内 `get_available_endpoints` 在同一类中出现两次定义（后者覆盖前者）
- **影响**：端点选择逻辑可能与作者意图不一致，影响路由/可用性判断
- **建议**：重命名并合并为单一实现，保留 `exclude` 参数与排序策略

### 2.2 每日限额 `DAILY_TRADE_LIMIT` 未在下单链路强制拦截（Mid）
- **证据**：`src/core/server.py:place_order` 仅校验 `_get_max_trade_amount()`，未校验“今日已交易 + 本次 cost <= DAILY_TRADE_LIMIT”
- **建议**：在 `place_order` 增加日限额硬拦截（并在测试脚本覆盖）

### 2.3 任务回调 Webhook 缺少签名（High）
- **证据**：`src/core/cloud/enhanced_publisher.py` 的 callback 调用未见签名
- **建议**：增加 `X-Heabl-Signature`（HMAC）+ timestamp，接收端校验

### 2.4 条件校验允许负数阈值（Low）
- **证据**：`src/utils/validators.py:validate_price_condition` 允许负数
- **建议**：增加阈值下限或在工具层限制（业务上 price < 0 无意义）

### 2.5 工具安全与 stdout 污染（Mid）
- **现状**：项目已经强力做了 stdout 隔离
- **建议**：
  - 严禁在 MCP 服务器进程里引入 `print()`
  - 第三方库若会写 stdout，应在初始化处统一重定向/禁用

---

## 3. 文档体系建议（你要的“说明文档”可以这样组织）

### 3.1 建议新增/维护的文档（按优先级）
- **P0**：工具总索引（自动生成）
  - 内容：工具名/参数/返回/位置/风险等级
- **P0**：常用工作流
  - 例如：
    - “分析→给建议→生成报告→落盘→发送邮件”
    - “哨兵任务→Redis→worker→通知”
- **P1**：错误码与排错手册
  - 每个关键链路：交易所连接、AI provider、邮件、Redis、Notion
- **P1**：安全手册
  - Key 管理、testnet 策略、下单风控、Webhook 签名

---

## 4. “全面检查命名规范统一”的落地路径（只建议）

- **第 1 步**：定义命名规范（参数名、返回字段、文件命名）
- **第 2 步**：生成工具清单 JSON（从 `tool_registry.list_tools()` 获取基础元信息，再补签名）
- **第 3 步**：按工具类别逐个收敛参数命名（保证兼容：旧参数保留一段时间）
- **第 4 步**：补齐 tests 覆盖（尤其是“下单风控/日限额/回调签名”）
