# 功能清单（结构化：大功能 / 子功能 / 小工具）

- 时间（北京时间）: `20251219_012951`
- Git HEAD: `1f3e998716d0fcb69832af3db3a8780088ce2eff`
- 统计口径：以代码中 **MCP Tool 对外接口**（`@mcp.tool()` / `mcp.tool()(...)`）为主，补充 **脚本入口/Worker** 与关键 **内部子系统能力**

---

## 0. 总览（你能用它做什么）

- **市场分析与信号**：技术分析、市场情绪、多币种扫描、信号汇总、仓位建议
- **账户与交易**：资产汇总、挂单查询、撤单、下单、策略执行、交易记录与统计
- **AI 与编排**：多角色调用、流水线分析、输出增强、外部专家二次意见
- **学习与训练系统**：交易前审计、盘中陪练、历史训练、策略回测、成长画像、纪律拦截
- **报告与通知**：自定义通知、模块化邮件报告、综合分析报告落盘/邮件
- **云端任务与调度**：任务发布/查询/重试/清理、调度器、API端点管理
- **运维与可观测**：系统状态、日志读取、缓存统计、性能慢函数统计、清缓存
- **外部集成**：Notion 同步、Redis 队列/云端 pipeline、Server酱/飞书通知
- **终端自检与测试**：一键自检脚本、tests runner

---

## 1) MCP 工具（对外接口）清单

> 说明：每条工具均列出：`工具名` / 作用 / 关键参数 / 返回 / 位置

### 1.1 市场分析与行情（`src/core/server.py` + `src/tools/market_analysis_tools.py`）

#### 1.1.1 核心技术分析（内置）
- **`get_comprehensive_analysis(symbol="BTC/USDT", timeframe="1h")`**
  - **作用**：综合技术分析报告（指标+结论）
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`get_market_analysis(symbol="BTC/USDT", timeframe="1h", enable_visualization=True)`**
  - **作用**：主要市场分析工具（支持可视化 JSON 输出）
  - **返回**：JSON 字符串（可视化）或 Markdown
  - **位置**：`src/core/server.py`

- **`get_market_sentiment(symbol="BTC/USDT")`**
  - **作用**：市场情绪（恐惧/贪婪式评分）
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`get_multi_symbol_overview()`**
  - **作用**：主流币种快速概览（价格/涨跌/RSI）
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

#### 1.1.2 模块化市场分析（skills 版）
- **`get_market_analysis_modular(symbol="BTC/USDT", timeframe="1h", modules="", return_format="markdown")`**
  - **作用**：基于 `skills.market_analysis.core.MarketAnalyzer` 的模块化分析
  - **参数**：
    - `modules`：逗号分隔，留空则默认模块
    - `return_format`：`markdown|json`
  - **返回**：Markdown 或 JSON 字符串
  - **位置**：`src/tools/market_analysis_tools.py`

### 1.2 AI 智能分析与信号决策（`src/core/server.py`）

- **`get_ai_trading_advice(symbol="BTC/USDT", mode="simple")`**
  - **作用**：双模式交易建议（`simple`/`professional`）
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`get_market_overview(mode="simple")`**
  - **作用**：市场全景扫描（简单/专业模式）
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`get_trading_signals(symbol="BTC/USDT")`**
  - **作用**：聚合多指标信号（买/卖/中性计票）
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`get_position_recommendation(symbol="BTC/USDT", account_balance=None, risk_tolerance="moderate")`**
  - **作用**：基于 ATR/风险偏好计算仓位建议
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

### 1.3 账户与交易（`src/core/server.py`）

- **`get_account_summary()`**
  - **作用**：账户资产摘要（批量获取 ticker 加速）
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`get_open_orders(symbol=None)`**
  - **作用**：查询挂单（不传 `symbol` 时按白名单遍历，避免告警）
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`cancel_order(order_id: str, symbol: str)`**
  - **作用**：撤单
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`place_order(symbol: str, side: str, amount: float, price: float=None, order_type: str="market")`**
  - **作用**：下单（市价/限价），包含单笔限额风控与“纪律拦截（可选）”
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`execute_strategy(symbol: str, strategy: str, amount: float)`**
  - **作用**：执行自动策略（RSI/均线/布林带等），触发后复用 `place_order`
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`get_available_strategies()`**
  - **作用**：列出可用策略与说明
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`calculate_position_size(account_balance: float, entry_price: float, stop_loss: float, risk_percent: float=1.0)`**
  - **作用**：经典风控仓位计算
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

### 1.4 交易记录与统计（`src/core/server.py`）

- **`get_trade_history(limit: int=10)`**
  - **作用**：读取交易历史（SQLite/CSV 自动回退）
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

- **`get_trade_statistics()`**
  - **作用**：交易统计（今日/本周/本月）
  - **返回**：Markdown
  - **位置**：`src/core/server.py`

### 1.5 通知与报告（`src/core/server.py` + `src/skills/report/flexible_report/service.py`）

- **`send_notification(title: str, message: str)`**
  - **作用**：发送自定义通知（邮件/通知通道封装）
  - **返回**：字符串
  - **位置**：`src/core/server.py`

- **`get_notification_settings()`**
  - **作用**：查看通知开关（env 默认 + 运行时覆盖）
  - **返回**：JSON 字符串
  - **位置**：`src/core/server.py`

- **`set_notification_settings(notify_trade_execution=None, notify_price_alerts=None, notify_daily_report=None, notify_system_errors=None, clear_overrides=False)`**
  - **作用**：运行时切换通知开关
  - **返回**：JSON 字符串
  - **位置**：`src/core/server.py`

- **`generate_analysis_report(symbol="BTC/USDT", mode="simple", timeframe="1h", include_sections="...", save_local=True, send_email_report=False, report_title="")`**
  - **作用**：生成综合分析报告（可落盘 `reports/`，可邮件）
  - **返回**：执行摘要（含保存路径/失败章节）
  - **位置**：`src/core/server.py`

- **`send_flexible_report(title="综合报告", send_A..send_I=False, **kwargs)`**
  - **作用**：模块化 HTML 邮件报告（A-I 章节），支持数据注入/模板渲染/备份
  - **返回**：字符串（发送结果/或构建结果）
  - **位置**：`src/skills/report/flexible_report/service.py`（通过 `register_tools` 注册到 MCP）

### 1.6 学习/训练/纪律系统（`src/tools/learning_tools.py`）

#### 1.6.1 会话与目录
- **`get_learning_catalog()`**：训练目录（JSON）
- **`start_learning_session(kind="scan", symbol="BTC/USDT", timeframe="1h", symbols="", candidates=10, pick=3)`**：创建训练会话（JSON）
- **`submit_learning_answer(session_id, answer, ai_enhance=False, tone="concise")`**：提交答案→评分/复盘
- **`get_learning_history(limit=20)`**：历史会话列表

#### 1.6.2 交易纪律拦截（Execution Guard）
- **`get_execution_guard_settings()`**：查看拦截规则与冷静期状态
- **`set_execution_guard_settings(enabled=None, trend_guard=None, trend_timeframe="", cooldown_seconds=None)`**：设置规则（持久化到本地文件）

#### 1.6.3 交易前安检
- **`audit_trade_reason(symbol="BTC/USDT", side="buy", reason="", timeframe="1h")`**：理由审计
- **`calculate_risk_reward(entry_price, stop_loss, take_profit, position_size=0)`**：盈亏比计算
- **`check_trend_alignment(symbol="BTC/USDT", side="buy", timeframe="1h")`**：趋势对齐
- **`check_fomo(symbol="BTC/USDT", side="buy", timeframe="1h")`**：FOMO 检测

#### 1.6.4 盘中陪练
- **`hunt_patterns(pattern, symbols="", timeframe="1h")`**：形态扫描
- **`get_profit_protection_advice(symbol="BTC/USDT", entry_price=0, side="long")`**：止盈保护
- **`analyze_loss(symbol="BTC/USDT", entry_price=0, exit_price=0, side="long", entry_reason="")`**：亏损复盘

#### 1.6.5 历史训练 / 回测
- **`simulate_what_if(symbol="BTC/USDT", hours_ago=1, stop_loss_pct=2.0, side="buy")`**：What-If
- **`start_blind_history_test(symbol="BTC/USDT", timeframe="1h", candles=30)`**：历史盲测
- **`reveal_blind_test(session_id, your_choice)`**：揭晓盲测
- **`backtest_strategy(symbol="BTC/USDT", strategy="", days=180, initial_capital=10000)`**：自然语言策略回测

#### 1.6.6 成长画像
- **`log_trade_decision(action, symbol="", side="", reason="", ai_warning="", outcome="", pnl_pct=0, tags="")`**：交易日记
- **`get_trade_journal(limit=20, symbol="", tag="")`**：查看日记
- **`record_bad_habit(habit, context="")`**：坏习惯记录
- **`get_habit_warnings()`**：坏习惯排行/警告
- **`get_trader_level()`**：等级/成就
- **`record_trade_result(is_win, stop_loss_executed=False)`**：记录胜负/止损执行

#### 1.6.7 辅助工具
- **`calculate_volatility_size(symbol="DOGE/USDT", intended_size_usdt=1000, base_symbol="BTC/USDT")`**：波动率换算仓位
- **`check_market_events(keywords="")`**：事件提醒
- **`quick_market_overview(symbols="")`**：多币种快速扫描

### 1.7 个人交易分析（`src/tools/personal_analytics_tools.py`）

- **`get_personal_analysis(modules="", limit=0, initial_capital=10000.0, return_format="markdown")`**：模块化个人分析（带查询备份）
- **`get_full_personal_analysis(initial_capital=10000.0, return_format="markdown")`**：全模块分析
- **`get_portfolio_analysis(return_format="markdown")`**：持仓/组合分析
- **`get_period_performance(period="all", return_format="markdown")`**：周期绩效
- **`get_trading_session_analysis(return_format="markdown")`**：时段分析
- **`get_cost_analysis(return_format="markdown")`**：成本分析
- **`add_trade_journal_note(order_id, note, tags="")`**：给交易添加复盘笔记
- **`record_funds_flow(amount, record_type, currency="USDT", note="", date="")`**：出入金记录
- **`search_trade_history(symbol="", side="", start_date="", end_date="", limit=20)`**：搜索交易历史
- **`list_personal_analysis_modules()`**：列出可用模块（含默认/全部）

### 1.8 编排与多模型（`src/tools/orchestration_tools.py`）

- **`ai_run_pipeline(task="analysis", user_input="", context="")`**：多阶段流水线（计划→执行）
- **`ai_enhance_output(content, tone="concise", context="")`**：输出增强
- **`ai_provider_snapshot()`**：provider 与路由快照
- **`ai_call_role(role, prompt, context="", max_tokens=1024, temperature=0.7, forced_endpoint="")`**：按角色调用
- **`ai_reason(prompt, context="")`**：推理
- **`ai_write(prompt, tone="professional")`**：写作
- **`ai_remember(prompt, documents="")`**：记忆/摘要
- **`ai_research(query, num_sources=5)`**：研究/搜索
- **`ai_critique(plan, criteria="")`**：审查
- **`ai_list_roles()`**：角色列表

#### 云端协同增强（同文件）
- **`consult_external_expert(query, model="deepseek", context="")`**：调用其他 provider 给第二意见
- **`set_cloud_sentry(symbol, condition, action="notify", notes="")`**：写入云端哨兵任务（Redis）
- **`sync_session_to_notion(summary, tags="")`**：会话摘要写入 Notion
- **`fetch_portfolio_snapshot()`**：资产快照（调用 `get_account_summary`）
- **`get_learning_context()`**：读取 `dev/lessons.md`

### 1.9 云端任务/调度/API 管理（`src/tools/cloud_tools.py`）

#### 调度器
- **`start_cloud_scheduler()`**：启动内置调度任务（heartbeat + cloud_queue）
- **`cloud_scheduler_snapshot()`**：调度器快照
- **`trigger_cloud_queue()`**：手动触发队列处理

#### 简易任务（CloudTaskPublisher）
- **`publish_cloud_task(name, payload="{}", schedule_every_seconds=0, tags="")`**
- **`list_cloud_tasks(status="")`**

#### 增强任务（EnhancedCloudTaskPublisher）
- **`publish_enhanced_task(name, payload="{}", priority=2, timeout=0, expires_in=0, depends_on="", max_retries=3, tags="")`**
- **`list_enhanced_tasks(status="", priority_min=0, limit=50)`**
- **`get_enhanced_task_stats()`**
- **`retry_failed_task(task_id)`**
- **`cleanup_expired_tasks()`**
- **`get_task_status(task_id)`**

#### 统一任务发布（TaskExecutor/submit_task）
- **`publish_task(task_type, action, params="{}", priority=..., timeout_seconds=0, depends_on="", notify_on_complete=False, callback_url="", context="", output_format="json", tags="", schedule_seconds=0, max_retries=3, expires_in_seconds=0)`**

#### API 端点管理
- **`add_api_endpoint(name, base_url, api_key, model, priority=1, max_requests_per_minute=60, timeout=30.0)`**
- **`get_api_manager_stats()`**
- **`reset_api_stats()`**

### 1.10 管理工具（`src/tools/admin_tools.py`）

- **`list_tools()`**：列出所有工具及启用状态（JSON）
- **`set_tool_enabled(tool_name, enabled)`**：运行时启用/禁用（软禁用）
- **`reset_tool_overrides()`**：清空运行时覆盖

### 1.11 运维/监控（`src/core/server.py`）

- **`get_server_logs(lines=30)`**：读取服务器日志文件
- **`get_system_status()`**：系统状态/连接/限额/路径
- **`get_cache_stats()`**：缓存统计
- **`get_performance_stats()`**：慢函数统计
- **`clear_cache(pattern=None)`**：清缓存

---

## 2) 非 MCP 的脚本入口（终端/Worker）

### 2.1 MCP Server 启动入口
- **`Heablcoin.py`**
  - **作用**：稳定入口，添加 `src` 到 `sys.path`，导出 `core.server` 公共接口，`__main__` 下 `mcp.run()`

### 2.2 终端综合自检入口
- **`Heablcoin-test.py`**
  - **作用**：不依赖 MCP 客户端的一键自检（连接/状态/分析/AI/账户/策略/日志/报告/通知/风控）
  - **典型参数**：`--quick`、`--ai-only`、`--report`、`--self-check`、`--trade`

### 2.3 测试套件运行器
- **`tests/run_tests.py`**
  - **作用**：按 suite 执行测试脚本
  - **suite**：`unit/email/integration/all`

### 2.4 Worker
- **`qinglong_worker.py`**
  - **作用**：轮询 Redis 中的哨兵任务（`set_cloud_sentry` 写入），满足条件触发通知（邮件）
  - **关键 env**：`RUN_ONCE`、`WORKER_INTERVAL`

- **`src/core/cloud/pipeline_worker.py`**
  - **作用**：Redis pipeline worker：Tavily 搜索 → LLM 总结 → Server酱/飞书通知 → 写回结果 hash
  - **关键 env**：`REDIS_URL`、`HEABL_TAVILY_KEY`、`HEABL_DEEPSEEK_KEY`、`SERVERCHAN_SENDKEY`、`FEISHU_WEBHOOK` 等

---

## 3) 关键内部子系统（不直接暴露为 Tool，但支撑功能）

- **交易所连接池**：`src/core/exchange.py`（ccxt + 连接复用 + testnet/mainnet）
- **工具安全封装**：`src/core/mcp_safety.py`（异常隔离 + stdout 防污染 + 软禁用）
- **工具注册表**：`src/core/tool_registry.py`（TOOL 元信息 + env/运行时开关）
- **任务系统**：`src/core/cloud/task_executor.py`、`enhanced_publisher.py`、`scheduler.py`、`publisher.py`
- **编排系统**：`src/core/orchestration/*`（角色、provider、计划、路由）
- **智能日志/缓存**：`src/utils/smart_logger.py`、`src/utils/smart_cache.py`（性能统计、缓存统计）
- **输入校验**：`src/utils/validators.py`（价格/条件/symbol/address）
- **存储适配**：`src/storage/*`（Notion、Redis 等）

