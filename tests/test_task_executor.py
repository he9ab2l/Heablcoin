############################################################
# ðŸ“˜ æ–‡ä»¶è¯´æ˜Žï¼š
# æœ¬æ–‡ä»¶å®žçŽ°çš„åŠŸèƒ½ï¼šæµ‹è¯•ç”¨ä¾‹ï¼šéªŒè¯ test_task_executor ç›¸å…³é€»è¾‘çš„æ­£ç¡®æ€§ä¸Žå›žå½’ã€‚
#
# ðŸ“‹ ç¨‹åºæ•´ä½“ä¼ªä»£ç ï¼ˆä¸­æ–‡ï¼‰ï¼š
# 1. åˆå§‹åŒ–ä¸»è¦ä¾èµ–ä¸Žå˜é‡
# 2. åŠ è½½è¾“å…¥æ•°æ®æˆ–æŽ¥æ”¶å¤–éƒ¨è¯·æ±‚
# 3. æ‰§è¡Œä¸»è¦é€»è¾‘æ­¥éª¤ï¼ˆå¦‚è®¡ç®—ã€å¤„ç†ã€è®­ç»ƒã€æ¸²æŸ“ç­‰ï¼‰
# 4. è¾“å‡ºæˆ–è¿”å›žç»“æžœ
# 5. å¼‚å¸¸å¤„ç†ä¸Žèµ„æºé‡Šæ”¾
#
# ðŸ”„ ç¨‹åºæµç¨‹å›¾ï¼ˆé€»è¾‘æµï¼‰ï¼š
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  è¾“å…¥æ•°æ® â”‚
# â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
#       â†“
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  æ ¸å¿ƒå¤„ç†é€»è¾‘ â”‚
# â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
#       â†“
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  è¾“å‡ºç»“æžœ â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ðŸ“Š æ•°æ®ç®¡é“è¯´æ˜Žï¼š
# æ•°æ®æµå‘ï¼šè¾“å…¥æº â†’ æ•°æ®æ¸…æ´—/è½¬æ¢ â†’ æ ¸å¿ƒç®—æ³•æ¨¡å— â†’ è¾“å‡ºç›®æ ‡ï¼ˆæ–‡ä»¶ / æŽ¥å£ / ç»ˆç«¯ï¼‰
#
# ðŸ§© æ–‡ä»¶ç»“æž„ï¼š
# - ä¾èµ–ï¼ˆæ ‡å‡†åº“ï¼‰ï¼šos, sys, tempfile
# - ä¾èµ–ï¼ˆç¬¬ä¸‰æ–¹ï¼‰ï¼šæ— 
# - ä¾èµ–ï¼ˆæœ¬åœ°ï¼‰ï¼šcore.cloud.enhanced_publisher, core.cloud.task_executor
#
# ðŸ•’ åˆ›å»ºæ—¶é—´ï¼š2025-12-19
############################################################

import os
import sys
import tempfile

REPO_ROOT = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
SRC_DIR = os.path.join(REPO_ROOT, "src")
sys.path.insert(0, SRC_DIR)

from core.cloud.task_executor import (
    TaskExecutor,
    TaskHandler,
    TaskPayload,
    TaskType,
    ExecutionResult,
)
from core.cloud.enhanced_publisher import EnhancedCloudTaskPublisher, TaskStatus


class DummyHandler(TaskHandler):
    def can_handle(self, payload: TaskPayload) -> bool:
        return True

    def execute(self, payload: TaskPayload) -> ExecutionResult:
        return ExecutionResult(True, {"echo": payload.params})


def _publisher_path():
    tmp = tempfile.mkdtemp(prefix="task_exec_test_")
    return EnhancedCloudTaskPublisher(path=os.path.join(tmp, "tasks.json"))


def test_task_executor_flow():
    publisher = _publisher_path()
    executor = TaskExecutor(publisher=publisher)
    executor.handlers = []
    executor.register_handler(DummyHandler())

    payload = TaskPayload(
        task_type=TaskType.CUSTOM,
        action="echo",
        params={"symbol": "BTC/USDT"},
    )
    task = publisher.publish(
        name="custom_echo",
        payload=payload.to_dict(),
        priority=3,
    )

    assert executor.process_pending_tasks() == 1
    stored = publisher.get_task(task.task_id)
    assert stored.status == TaskStatus.COMPLETED.value
    assert stored.result["output"]["echo"]["symbol"] == "BTC/USDT"
